<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.4.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-ui2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/05/29/ui2/" class="article-date">
  <time datetime="2022-05-29T09:36:53.000Z" itemprop="datePublished">2022-05-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/05/29/ui2/">【知识】【python】【adb】uiautomator2 包文档</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>python 通过 uiautomator2 包操作安卓设备界面的各种方法</p>
<h1 id="安装及-init"><a href="#安装及-init" class="headerlink" title="安装及 init"></a>安装及 init</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install uiautomator2</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> uiautomator2 <span class="keyword">as</span> ui2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. wifi 连</span></span><br><span class="line">d = ui2.connect(<span class="string">&#x27;10.0.0.1&#x27;</span>)</span><br><span class="line"><span class="comment"># 2. usb 连</span></span><br><span class="line">d = ui2.connect(<span class="string">&#x27;123456f&#x27;</span>)</span><br><span class="line"><span class="comment"># 3. adb wifi 连</span></span><br><span class="line">d = u2.connect_adb_wifi(<span class="string">&quot;10.0.0.1:5555&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(d.info())</span><br></pre></td></tr></table></figure>

<h1 id="API-合集"><a href="#API-合集" class="headerlink" title="API 合集"></a>API 合集</h1><h2 id="APP-操作"><a href="#APP-操作" class="headerlink" title="APP 操作"></a>APP 操作</h2><ol>
<li><p>安装 app<br><code>d.app_install(&#39;http://some-domain.com/some.apk&#39;)</code></p>
</li>
<li><p>启动 app</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 默认的这种方法是先通过atx-agent解析apk包的mainActivity，然后调用am start -n $package/$activity启动</span></span><br><span class="line">d.app_start(<span class="string">&quot;com.example.hello_world&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 monkey -p com.example.hello_world -c android.intent.category.LAUNCHER 1 启动</span></span><br><span class="line"><span class="comment"># 这种方法有个副作用，它自动会将手机的旋转锁定给关掉</span></span><br><span class="line">d.app_start(<span class="string">&quot;com.example.hello_world&quot;</span>, use_monkey=<span class="literal">True</span>) <span class="comment"># start with package name</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过指定main activity的方式启动应用，等价于调用am start -n com.example.hello_world/.MainActivity</span></span><br><span class="line">d.app_start(<span class="string">&quot;com.example.hello_world&quot;</span>, <span class="string">&quot;.MainActivity&quot;</span>)</span><br></pre></td></tr></table></figure></li>
<li><p>停止 app 运行</p>
</li>
</ol>
<ul>
<li><p>单个 app</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># equivalent to `am force-stop`, thus you could lose data</span></span><br><span class="line">d.app_stop(<span class="string">&quot;com.example.hello_world&quot;</span>) </span><br><span class="line"><span class="comment"># equivalent to `pm clear`</span></span><br><span class="line">d.app_clear(<span class="string">&#x27;com.example.hello_world&#x27;</span>)</span><br></pre></td></tr></table></figure></li>
<li><p>所有 app</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># stop all</span></span><br><span class="line">d.app_stop_all()</span><br><span class="line"><span class="comment"># stop all app except for com.examples.demo</span></span><br><span class="line">d.app_stop_all(excludes=[<span class="string">&#x27;com.examples.demo&#x27;</span>])</span><br></pre></td></tr></table></figure></li>
</ul>
<ol start="4">
<li>获取 app 信息</li>
</ol>
<ul>
<li><p>指定 app</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">d.app_info(<span class="string">&quot;com.examples.demo&quot;</span>)</span><br><span class="line"><span class="comment"># expect output</span></span><br><span class="line"><span class="comment">#&#123;</span></span><br><span class="line"><span class="comment">#    &quot;mainActivity&quot;: &quot;com.github.uiautomator.MainActivity&quot;,</span></span><br><span class="line"><span class="comment">#    &quot;label&quot;: &quot;ATX&quot;,</span></span><br><span class="line"><span class="comment">#    &quot;versionName&quot;: &quot;1.1.7&quot;,</span></span><br><span class="line"><span class="comment">#    &quot;versionCode&quot;: 1001007,</span></span><br><span class="line"><span class="comment">#    &quot;size&quot;:1760809</span></span><br><span class="line"><span class="comment">#&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># save app icon</span></span><br><span class="line">img = d.app_icon(<span class="string">&quot;com.examples.demo&quot;</span>)</span><br><span class="line">img.save(<span class="string">&quot;icon.png&quot;</span>)</span><br></pre></td></tr></table></figure></li>
<li><p>正在运行的 app</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">d.app_list_running()</span><br><span class="line"><span class="comment"># expect output</span></span><br><span class="line"><span class="comment"># [&quot;com.xxxx.xxxx&quot;, &quot;com.github.uiautomator&quot;, &quot;xxxx&quot;]</span></span><br></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pid = d.app_wait(<span class="string">&quot;com.example.android&quot;</span>) <span class="comment"># 等待应用运行, return pid(int)</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> pid:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;com.example.android is not running&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;com.example.android pid is %d&quot;</span> % pid)</span><br><span class="line"></span><br><span class="line">d.app_wait(<span class="string">&quot;com.example.android&quot;</span>, front=<span class="literal">True</span>) <span class="comment"># 等待应用前台运行</span></span><br><span class="line">d.app_wait(<span class="string">&quot;com.example.android&quot;</span>, timeout=<span class="number">20.0</span>) <span class="comment"># 最长等待时间20s（默认）</span></span><br></pre></td></tr></table></figure>

<h2 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h2><ol>
<li><p>文件传输<br>push</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># push to a folder</span></span><br><span class="line">d.push(<span class="string">&quot;foo.txt&quot;</span>, <span class="string">&quot;/sdcard/&quot;</span>)</span><br><span class="line"><span class="comment"># push and rename</span></span><br><span class="line">d.push(<span class="string">&quot;foo.txt&quot;</span>, <span class="string">&quot;/sdcard/bar.txt&quot;</span>)</span><br><span class="line"><span class="comment"># push fileobj</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;foo.txt&quot;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    d.push(f, <span class="string">&quot;/sdcard/&quot;</span>)</span><br><span class="line"><span class="comment"># push and change file access mode</span></span><br><span class="line">d.push(<span class="string">&quot;foo.sh&quot;</span>, <span class="string">&quot;/data/local/tmp/&quot;</span>, mode=<span class="number">0o755</span>)</span><br></pre></td></tr></table></figure>
<p>pull</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">d.pull(<span class="string">&quot;/sdcard/tmp.txt&quot;</span>, <span class="string">&quot;tmp.txt&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># FileNotFoundError will raise if the file is not found on the device</span></span><br><span class="line">d.pull(<span class="string">&quot;/sdcard/some-file-not-exists.txt&quot;</span>, <span class="string">&quot;tmp.txt&quot;</span>)</span><br></pre></td></tr></table></figure></li>
<li><p>shell</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">output, exit_code = d.shell(<span class="string">&quot;pwd&quot;</span>, timeout=<span class="number">60</span>) <span class="comment"># timeout 60s (Default)</span></span><br><span class="line"><span class="comment"># output: &quot;/\n&quot;, exit_code: 0</span></span><br><span class="line"><span class="comment"># Similar to command: adb shell pwd</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Since `shell` function return type is `namedtuple(&quot;ShellResponse&quot;, (&quot;output&quot;, &quot;exit_code&quot;))`</span></span><br><span class="line"><span class="comment"># so we can do some tricks</span></span><br><span class="line">output = d.shell(<span class="string">&quot;pwd&quot;</span>).output</span><br><span class="line">exit_code = d.shell(<span class="string">&quot;pwd&quot;</span>).exit_code</span><br></pre></td></tr></table></figure></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">r = d.shell(<span class="string">&quot;logcat&quot;</span>, stream=<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># r: requests.models.Response</span></span><br><span class="line">deadline = time.time() + <span class="number">10</span> <span class="comment"># run maxium 10s</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> r.iter_lines(): <span class="comment"># r.iter_lines(chunk_size=512, decode_unicode=None, delimiter=None)</span></span><br><span class="line">        <span class="keyword">if</span> time.time() &gt; deadline:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Read:&quot;</span>, line.decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    r.close() <span class="comment"># this method must be called</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li><p>session<br>代表一个 app 的生命周期，可以用来启动、停用 app，检测 app crash</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">sess = d.session(<span class="string">&quot;com.netease.cloudmusic&quot;</span>) <span class="comment"># start 网易云音乐</span></span><br><span class="line">sess.close() <span class="comment"># 停止网易云音乐</span></span><br><span class="line">sess.restart() <span class="comment"># 冷启动网易云音乐</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> d.session(<span class="string">&quot;com.netease.cloudmusic&quot;</span>) <span class="keyword">as</span> sess:</span><br><span class="line">    sess(text=<span class="string">&quot;Play&quot;</span>).click()</span><br><span class="line"></span><br><span class="line"><span class="comment"># launch app if not running, skip launch if already running</span></span><br><span class="line">sess = d.session(<span class="string">&quot;com.netease.cloudmusic&quot;</span>, attach=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># raise SessionBrokenError if not running</span></span><br><span class="line">sess = d.session(<span class="string">&quot;com.netease.cloudmusic&quot;</span>, attach=<span class="literal">True</span>, strict=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># When app is still running</span></span><br><span class="line">sess(text=<span class="string">&quot;Music&quot;</span>).click() <span class="comment"># operation goes normal</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># If app crash or quit</span></span><br><span class="line">sess(text=<span class="string">&quot;Music&quot;</span>).click() <span class="comment"># raise SessionBrokenError</span></span><br><span class="line"><span class="comment"># other function calls under session will raise SessionBrokenError too</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># check if session is ok.</span></span><br><span class="line"><span class="comment"># Warning: function name may change in the future</span></span><br><span class="line">sess.running() <span class="comment"># True or False</span></span><br></pre></td></tr></table></figure></li>
<li><p>设备信息</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">d.info</span><br><span class="line"><span class="comment"># &#123; </span></span><br><span class="line"><span class="comment">#    u&#x27;displayRotation&#x27;: 0,</span></span><br><span class="line"><span class="comment">#    u&#x27;displaySizeDpY&#x27;: 640,</span></span><br><span class="line"><span class="comment">#    u&#x27;displaySizeDpX&#x27;: 360,</span></span><br><span class="line"><span class="comment">#    u&#x27;currentPackageName&#x27;: u&#x27;com.android.launcher&#x27;,</span></span><br><span class="line"><span class="comment">#    u&#x27;productName&#x27;: u&#x27;takju&#x27;,</span></span><br><span class="line"><span class="comment">#    u&#x27;displayWidth&#x27;: 720,</span></span><br><span class="line"><span class="comment">#    u&#x27;sdkInt&#x27;: 18,</span></span><br><span class="line"><span class="comment">#    u&#x27;displayHeight&#x27;: 1184,</span></span><br><span class="line"><span class="comment">#    u&#x27;naturalOrientation&#x27;: True</span></span><br><span class="line"><span class="comment">#&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(d.window_size())</span><br><span class="line"><span class="comment"># device upright output example: (1080, 1920)</span></span><br><span class="line"><span class="comment"># device horizontal output example: (1920, 1080)</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(d.app_current())</span><br><span class="line"><span class="comment"># Output example 1: &#123;&#x27;activity&#x27;: &#x27;.Client&#x27;, &#x27;package&#x27;: &#x27;com.netease.example&#x27;, &#x27;pid&#x27;: 23710&#125;</span></span><br><span class="line"><span class="comment"># Output example 2: &#123;&#x27;activity&#x27;: &#x27;.Client&#x27;, &#x27;package&#x27;: &#x27;com.netease.example&#x27;&#125;</span></span><br><span class="line"><span class="comment"># Output example 3: &#123;&#x27;activity&#x27;: None, &#x27;package&#x27;: None&#125;</span></span><br><span class="line"></span><br><span class="line">d.wait_activity(<span class="string">&quot;.ApiDemos&quot;</span>, timeout=<span class="number">10</span>) <span class="comment"># default timeout 10.0 seconds</span></span><br><span class="line"><span class="comment"># Output: true of false</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(d.serial)</span><br><span class="line"><span class="comment"># output example: 74aAEDR428Z9</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(d.wlan_ip)</span><br><span class="line"><span class="comment"># output example: 10.0.0.1</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(d.device_info)</span><br><span class="line"><span class="comment"># &#123;&#x27;udid&#x27;: &#x27;3578298f-b4:0b:44:e6:1f:90-OD103&#x27;,</span></span><br><span class="line"><span class="comment">#  &#x27;version&#x27;: &#x27;7.1.1&#x27;,</span></span><br><span class="line"><span class="comment">#  &#x27;serial&#x27;: &#x27;3578298f&#x27;,</span></span><br><span class="line"><span class="comment">#  &#x27;brand&#x27;: &#x27;SMARTISAN&#x27;,</span></span><br><span class="line"><span class="comment">#  &#x27;model&#x27;: &#x27;OD103&#x27;,</span></span><br><span class="line"><span class="comment">#  &#x27;hwaddr&#x27;: &#x27;b4:0b:44:e6:1f:90&#x27;,</span></span><br><span class="line"><span class="comment">#  &#x27;port&#x27;: 7912,</span></span><br><span class="line"><span class="comment">#  &#x27;sdk&#x27;: 25,</span></span><br><span class="line"><span class="comment">#  &#x27;agentVersion&#x27;: &#x27;dev&#x27;,</span></span><br><span class="line"><span class="comment">#  &#x27;display&#x27;: &#123;&#x27;width&#x27;: 1080, &#x27;height&#x27;: 1920&#125;,</span></span><br><span class="line"><span class="comment">#  &#x27;battery&#x27;: &#123;&#x27;acPowered&#x27;: False,</span></span><br><span class="line"><span class="comment">#   &#x27;usbPowered&#x27;: False,</span></span><br><span class="line"><span class="comment">#   &#x27;wirelessPowered&#x27;: False,</span></span><br><span class="line"><span class="comment">#   &#x27;status&#x27;: 3,</span></span><br><span class="line"><span class="comment">#   &#x27;health&#x27;: 0,</span></span><br><span class="line"><span class="comment">#   &#x27;present&#x27;: True,</span></span><br><span class="line"><span class="comment">#   &#x27;level&#x27;: 99,</span></span><br><span class="line"><span class="comment">#   &#x27;scale&#x27;: 100,</span></span><br><span class="line"><span class="comment">#   &#x27;voltage&#x27;: 4316,</span></span><br><span class="line"><span class="comment">#   &#x27;temperature&#x27;: 272,</span></span><br><span class="line"><span class="comment">#   &#x27;technology&#x27;: &#x27;Li-ion&#x27;&#125;,</span></span><br><span class="line"><span class="comment">#  &#x27;memory&#x27;: &#123;&#x27;total&#x27;: 3690280, &#x27;around&#x27;: &#x27;4 GB&#x27;&#125;,</span></span><br><span class="line"><span class="comment">#  &#x27;cpu&#x27;: &#123;&#x27;cores&#x27;: 8, &#x27;hardware&#x27;: &#x27;Qualcomm Technologies, Inc MSM8953Pro&#x27;&#125;,</span></span><br><span class="line"><span class="comment">#  &#x27;presenceChangedAt&#x27;: &#x27;0001-01-01T00:00:00Z&#x27;,</span></span><br><span class="line"><span class="comment">#  &#x27;usingBeganAt&#x27;: &#x27;0001-01-01T00:00:00Z&#x27;</span></span><br><span class="line"><span class="comment"># &#125;</span></span><br></pre></td></tr></table></figure></li>
<li><p>剪切板</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">d.set_clipboard(<span class="string">&#x27;text&#x27;</span>, <span class="string">&#x27;label&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(d.clipboard)</span><br></pre></td></tr></table></figure></li>
<li><p>事件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">d.screen_on() <span class="comment"># turn on the screen</span></span><br><span class="line">d.screen_off() <span class="comment"># turn off the screen</span></span><br><span class="line"></span><br><span class="line">d.info.get(<span class="string">&#x27;screenOn&#x27;</span>) <span class="comment"># require Android &gt;= 4.4</span></span><br><span class="line"></span><br><span class="line">d.press(<span class="string">&quot;home&quot;</span>) <span class="comment"># press the home key, with key name</span></span><br><span class="line">d.press(<span class="string">&quot;back&quot;</span>) <span class="comment"># press the back key, with key name</span></span><br><span class="line">d.press(<span class="number">0x07</span>, <span class="number">0x02</span>) <span class="comment"># press keycode 0x07(&#x27;0&#x27;) with META ALT(0x02)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># These key names are currently supported:</span></span><br><span class="line"><span class="comment"># home</span></span><br><span class="line"><span class="comment"># back</span></span><br><span class="line"><span class="comment"># left</span></span><br><span class="line"><span class="comment"># right</span></span><br><span class="line"><span class="comment"># up</span></span><br><span class="line"><span class="comment"># down</span></span><br><span class="line"><span class="comment"># center</span></span><br><span class="line"><span class="comment"># menu</span></span><br><span class="line"><span class="comment"># search</span></span><br><span class="line"><span class="comment"># enter</span></span><br><span class="line"><span class="comment"># delete ( or del)</span></span><br><span class="line"><span class="comment"># recent (recent apps)</span></span><br><span class="line"><span class="comment"># volume_up</span></span><br><span class="line"><span class="comment"># volume_down</span></span><br><span class="line"><span class="comment"># volume_mute</span></span><br><span class="line"><span class="comment"># camera</span></span><br><span class="line"><span class="comment"># power</span></span><br></pre></td></tr></table></figure></li>
</ol>
<ul>
<li><p>手势操作</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">d.unlock()</span><br><span class="line"><span class="comment"># This is equivalent to</span></span><br><span class="line"><span class="comment"># 1. launch activity: com.github.uiautomator.ACTION_IDENTIFY</span></span><br><span class="line"><span class="comment"># 2. press the &quot;home&quot; key</span></span><br><span class="line"></span><br><span class="line">d.click(x, y)</span><br><span class="line"></span><br><span class="line">d.double_click(x, y)</span><br><span class="line">d.double_click(x, y, <span class="number">0.1</span>) <span class="comment"># default duration between two click is 0.1s</span></span><br><span class="line"></span><br><span class="line">d.long_click(x, y)</span><br><span class="line">d.long_click(x, y, <span class="number">0.5</span>) <span class="comment"># long click 0.5s (default)</span></span><br><span class="line"></span><br><span class="line">d.swipe(sx, sy, ex, ey)</span><br><span class="line">d.swipe(sx, sy, ex, ey, <span class="number">0.5</span>) <span class="comment"># swipe for 0.5s(default)</span></span><br><span class="line"></span><br><span class="line">d.swipe_ext(<span class="string">&quot;right&quot;</span>) <span class="comment"># 手指右滑，4选1 &quot;left&quot;, &quot;right&quot;, &quot;up&quot;, &quot;down&quot;</span></span><br><span class="line">d.swipe_ext(<span class="string">&quot;right&quot;</span>, scale=<span class="number">0.9</span>) <span class="comment"># 默认0.9, 滑动距离为屏幕宽度的90%</span></span><br><span class="line">d.swipe_ext(<span class="string">&quot;right&quot;</span>, box=(<span class="number">0</span>, <span class="number">0</span>, <span class="number">100</span>, <span class="number">100</span>)) <span class="comment"># 在 (0,0) -&gt; (100, 100) 这个区域做滑动</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 实践发现上滑或下滑的时候，从中点开始滑动成功率会高一些</span></span><br><span class="line">d.swipe_ext(<span class="string">&quot;up&quot;</span>, scale=<span class="number">0.8</span>) <span class="comment"># 代码会vkk</span></span><br><span class="line"><span class="comment"># 还可以使用Direction作为参数</span></span><br><span class="line"><span class="keyword">from</span> uiautomator2 <span class="keyword">import</span> Direction</span><br><span class="line">d.swipe_ext(Direction.FORWARD) <span class="comment"># 页面下翻, 等价于 d.swipe_ext(&quot;up&quot;), 只是更好理解</span></span><br><span class="line">d.swipe_ext(Direction.BACKWARD) <span class="comment"># 页面上翻</span></span><br><span class="line">d.swipe_ext(Direction.HORIZ_FORWARD) <span class="comment"># 页面水平右翻</span></span><br><span class="line">d.swipe_ext(Direction.HORIZ_BACKWARD) <span class="comment"># 页面水平左翻</span></span><br><span class="line"></span><br><span class="line">d.drag(sx, sy, ex, ey)</span><br><span class="line">d.drag(sx, sy, ex, ey, <span class="number">0.5</span>) <span class="comment"># swipe for 0.5s(default)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># swipe from point(x0, y0) to point(x1, y1) then to point(x2, y2)</span></span><br><span class="line"><span class="comment"># time will speed 0.2s bwtween two points</span></span><br><span class="line">d.swipe_points([(x0, y0), (x1, y1), (x2, y2)], <span class="number">0.2</span>)</span><br><span class="line"></span><br><span class="line">d.touch.down(<span class="number">10</span>, <span class="number">10</span>) <span class="comment"># 模拟按下</span></span><br><span class="line">time.sleep(<span class="number">.01</span>) <span class="comment"># down 和 move 之间的延迟，自己控制</span></span><br><span class="line">d.touch.move(<span class="number">15</span>, <span class="number">15</span>) <span class="comment"># 模拟移动</span></span><br><span class="line">d.touch.up() <span class="comment"># 模拟抬起</span></span><br></pre></td></tr></table></figure></li>
<li><p>屏幕相关</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># retrieve orientation. the output could be &quot;natural&quot; or &quot;left&quot; or &quot;right&quot; or &quot;upsidedown&quot;</span></span><br><span class="line">orientation = d.orientation</span><br><span class="line"><span class="comment"># WARNING: not pass testing in my TT-M1</span></span><br><span class="line"><span class="comment"># set orientation and freeze rotation.</span></span><br><span class="line"><span class="comment"># notes: setting &quot;upsidedown&quot; requires Android&gt;=4.3.</span></span><br><span class="line">d.set_orientation(<span class="string">&#x27;l&#x27;</span>) <span class="comment"># or &quot;left&quot;</span></span><br><span class="line">d.set_orientation(<span class="string">&quot;l&quot;</span>) <span class="comment"># or &quot;left&quot;</span></span><br><span class="line">d.set_orientation(<span class="string">&quot;r&quot;</span>) <span class="comment"># or &quot;right&quot;</span></span><br><span class="line">d.set_orientation(<span class="string">&quot;n&quot;</span>) <span class="comment"># or &quot;natural&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># freeze rotation</span></span><br><span class="line">d.freeze_rotation()</span><br><span class="line"><span class="comment"># un-freeze rotation</span></span><br><span class="line">d.freeze_rotation(<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># take screenshot and save to a file on the computer, require Android&gt;=4.2.</span></span><br><span class="line">d.screenshot(<span class="string">&quot;home.jpg&quot;</span>)</span><br><span class="line"><span class="comment"># get PIL.Image formatted images. Naturally, you need pillow installed first</span></span><br><span class="line">image = d.screenshot() <span class="comment"># default format=&quot;pillow&quot;</span></span><br><span class="line">image.save(<span class="string">&quot;home.jpg&quot;</span>) <span class="comment"># or home.png. Currently, only png and jpg are supported</span></span><br><span class="line"><span class="comment"># get opencv formatted images. Naturally, you need numpy and cv2 installed first</span></span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line">image = d.screenshot(<span class="built_in">format</span>=<span class="string">&#x27;opencv&#x27;</span>)</span><br><span class="line">cv2.imwrite(<span class="string">&#x27;home.jpg&#x27;</span>, image)</span><br><span class="line"><span class="comment"># get raw jpeg data</span></span><br><span class="line">imagebin = d.screenshot(<span class="built_in">format</span>=<span class="string">&#x27;raw&#x27;</span>)</span><br><span class="line"><span class="built_in">open</span>(<span class="string">&quot;some.jpg&quot;</span>, <span class="string">&quot;wb&quot;</span>).write(imagebin)</span><br><span class="line"></span><br><span class="line"><span class="comment"># get the UI hierarchy dump content (unicoded).</span></span><br><span class="line">xml = d.dump_hierarchy()</span><br><span class="line"></span><br><span class="line">d.open_notification()</span><br><span class="line">d.open_quick_settings()</span><br></pre></td></tr></table></figure></li>
<li><p>选择器（selector）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Select the object with text &#x27;Clock&#x27; and its className is &#x27;android.widget.TextView&#x27;</span></span><br><span class="line">d(text=<span class="string">&#x27;Clock&#x27;</span>, className=<span class="string">&#x27;android.widget.TextView&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Selector supports below parameters. Refer to UiSelector Java doc for detailed information.</span></span><br><span class="line"><span class="comment"># text, textContains, textMatches, textStartsWith</span></span><br><span class="line"><span class="comment"># className, classNameMatches</span></span><br><span class="line"><span class="comment"># description, descriptionContains, descriptionMatches, descriptionStartsWith</span></span><br><span class="line"><span class="comment"># checkable, checked, clickable, longClickable</span></span><br><span class="line"><span class="comment"># scrollable, enabled,focusable, focused, selected</span></span><br><span class="line"><span class="comment"># packageName, packageNameMatches</span></span><br><span class="line"><span class="comment"># resourceId, resourceIdMatches</span></span><br><span class="line"><span class="comment"># index, instance</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># get the children or grandchildren</span></span><br><span class="line">d(className=<span class="string">&quot;android.widget.ListView&quot;</span>).child(text=<span class="string">&quot;Bluetooth&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># get siblings</span></span><br><span class="line">d(text=<span class="string">&quot;Google&quot;</span>).sibling(className=<span class="string">&quot;android.widget.ImageView&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># get the child matching the condition className=&quot;android.widget.LinearLayout&quot;</span></span><br><span class="line"><span class="comment"># and also its children or grandchildren with text &quot;Bluetooth&quot;</span></span><br><span class="line">d(className=<span class="string">&quot;android.widget.ListView&quot;</span>, resourceId=<span class="string">&quot;android:id/list&quot;</span>) \</span><br><span class="line"> .child_by_text(<span class="string">&quot;Bluetooth&quot;</span>, className=<span class="string">&quot;android.widget.LinearLayout&quot;</span>)</span><br><span class="line"><span class="comment"># get children by allowing scroll search</span></span><br><span class="line">d(className=<span class="string">&quot;android.widget.ListView&quot;</span>, resourceId=<span class="string">&quot;android:id/list&quot;</span>) \</span><br><span class="line"> .child_by_text(</span><br><span class="line">    <span class="string">&quot;Bluetooth&quot;</span>,</span><br><span class="line">    allow_scroll_search=<span class="literal">True</span>,</span><br><span class="line">    className=<span class="string">&quot;android.widget.LinearLayout&quot;</span></span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line"><span class="comment">## select &quot;switch&quot; on the right side of &quot;Wi‑Fi&quot;</span></span><br><span class="line">d(text=<span class="string">&quot;Wi‑Fi&quot;</span>).right(className=<span class="string">&quot;android.widget.Switch&quot;</span>).click()</span><br><span class="line">d(text=<span class="string">&quot;Add new&quot;</span>, instance=<span class="number">0</span>)  <span class="comment"># which means the first instance with text &quot;Add new&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># get the count of views with text &quot;Add new&quot; on current screen</span></span><br><span class="line">d(text=<span class="string">&quot;Add new&quot;</span>).count</span><br><span class="line"><span class="comment"># same as count property</span></span><br><span class="line"><span class="built_in">len</span>(d(text=<span class="string">&quot;Add new&quot;</span>))</span><br><span class="line"><span class="comment"># get the instance via index</span></span><br><span class="line">d(text=<span class="string">&quot;Add new&quot;</span>)[<span class="number">0</span>]</span><br><span class="line">d(text=<span class="string">&quot;Add new&quot;</span>)[<span class="number">1</span>]</span><br><span class="line">...</span><br><span class="line"><span class="comment"># iterator</span></span><br><span class="line"><span class="keyword">for</span> view <span class="keyword">in</span> d(text=<span class="string">&quot;Add new&quot;</span>):</span><br><span class="line">    view.info  <span class="comment"># ...</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>获取到目标元素后查看状态与信息</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">d(text=<span class="string">&quot;Settings&quot;</span>).exists <span class="comment"># True if exists, else False</span></span><br><span class="line">d.exists(text=<span class="string">&quot;Settings&quot;</span>) <span class="comment"># alias of above property.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># advanced usage</span></span><br><span class="line">d(text=<span class="string">&quot;Settings&quot;</span>).exists(timeout=<span class="number">3</span>) <span class="comment"># wait Settings appear in 3s, same as .wait(3)</span></span><br><span class="line"></span><br><span class="line">d(text=<span class="string">&quot;Settings&quot;</span>).info</span><br><span class="line"></span><br><span class="line">d(text=<span class="string">&quot;Settings&quot;</span>).get_text()  <span class="comment"># get widget text</span></span><br><span class="line">d(text=<span class="string">&quot;Settings&quot;</span>).set_text(<span class="string">&quot;My text...&quot;</span>)  <span class="comment"># set the text</span></span><br><span class="line">d(text=<span class="string">&quot;Settings&quot;</span>).clear_text()  <span class="comment"># clear the text</span></span><br><span class="line"></span><br><span class="line">x, y = d(text=<span class="string">&quot;Settings&quot;</span>).center()</span><br><span class="line"><span class="comment"># x, y = d(text=&quot;Settings&quot;).center(offset=(0, 0)) # left-top x, y</span></span><br><span class="line"></span><br><span class="line">im = d(text=<span class="string">&quot;Settings&quot;</span>).screenshot()</span><br><span class="line">im.save(<span class="string">&quot;settings.jpg&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># click on the center of the specific ui object</span></span><br><span class="line">d(text=<span class="string">&quot;Settings&quot;</span>).click()</span><br><span class="line"></span><br><span class="line"><span class="comment"># wait element to appear for at most 10 seconds and then click</span></span><br><span class="line">d(text=<span class="string">&quot;Settings&quot;</span>).click(timeout=<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># click with offset(x_offset, y_offset)</span></span><br><span class="line"><span class="comment"># click_x = x_offset * width + x_left_top</span></span><br><span class="line"><span class="comment"># click_y = y_offset * height + y_left_top</span></span><br><span class="line">d(text=<span class="string">&quot;Settings&quot;</span>).click(offset=(<span class="number">0.5</span>, <span class="number">0.5</span>)) <span class="comment"># Default center</span></span><br><span class="line">d(text=<span class="string">&quot;Settings&quot;</span>).click(offset=(<span class="number">0</span>, <span class="number">0</span>)) <span class="comment"># click left-top</span></span><br><span class="line">d(text=<span class="string">&quot;Settings&quot;</span>).click(offset=(<span class="number">1</span>, <span class="number">1</span>)) <span class="comment"># click right-bottom</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># click when exists in 10s, default timeout 0s</span></span><br><span class="line">clicked = d(text=<span class="string">&#x27;Skip&#x27;</span>).click_exists(timeout=<span class="number">10.0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># click until element gone, return bool</span></span><br><span class="line">is_gone = d(text=<span class="string">&quot;Skip&quot;</span>).click_gone(maxretry=<span class="number">10</span>, interval=<span class="number">1.0</span>) <span class="comment"># maxretry default 10, interval default 1.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># long click on the center of the specific UI object</span></span><br><span class="line">d(text=<span class="string">&quot;Settings&quot;</span>).long_click()</span><br><span class="line"></span><br><span class="line"><span class="comment"># notes : drag can not be used for Android&lt;4.3.</span></span><br><span class="line"><span class="comment"># drag the UI object to a screen point (x, y), in 0.5 second</span></span><br><span class="line">d(text=<span class="string">&quot;Settings&quot;</span>).drag_to(x, y, duration=<span class="number">0.5</span>)</span><br><span class="line"><span class="comment"># drag the UI object to (the center position of) another UI object, in 0.25 second</span></span><br><span class="line">d(text=<span class="string">&quot;Settings&quot;</span>).drag_to(text=<span class="string">&quot;Clock&quot;</span>, duration=<span class="number">0.25</span>)</span><br><span class="line"></span><br><span class="line">d(text=<span class="string">&quot;Settings&quot;</span>).swipe(<span class="string">&quot;right&quot;</span>)</span><br><span class="line">d(text=<span class="string">&quot;Settings&quot;</span>).swipe(<span class="string">&quot;left&quot;</span>, steps=<span class="number">10</span>)</span><br><span class="line">d(text=<span class="string">&quot;Settings&quot;</span>).swipe(<span class="string">&quot;up&quot;</span>, steps=<span class="number">20</span>) <span class="comment"># 1 steps is about 5ms, so 20 steps is about 0.1s</span></span><br><span class="line">d(text=<span class="string">&quot;Settings&quot;</span>).swipe(<span class="string">&quot;down&quot;</span>, steps=<span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">d(text=<span class="string">&quot;Settings&quot;</span>).gesture((sx1, sy1), (sx2, sy2), (ex1, ey1), (ex2, ey2))</span><br><span class="line"></span><br><span class="line"><span class="comment"># notes : pinch can not be set until Android 4.3.</span></span><br><span class="line"><span class="comment"># from edge to center. here is &quot;In&quot; not &quot;in&quot;</span></span><br><span class="line">d(text=<span class="string">&quot;Settings&quot;</span>).pinch_in(percent=<span class="number">100</span>, steps=<span class="number">10</span>)</span><br><span class="line"><span class="comment"># from center to edge</span></span><br><span class="line">d(text=<span class="string">&quot;Settings&quot;</span>).pinch_out()</span><br><span class="line"></span><br><span class="line"><span class="comment"># wait until the ui object appears</span></span><br><span class="line">d(text=<span class="string">&quot;Settings&quot;</span>).wait(timeout=<span class="number">3.0</span>) <span class="comment"># return bool</span></span><br><span class="line"><span class="comment"># wait until the ui object gone</span></span><br><span class="line">d(text=<span class="string">&quot;Settings&quot;</span>).wait_gone(timeout=<span class="number">1.0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># fling forward(default) vertically(default) </span></span><br><span class="line">d(scrollable=<span class="literal">True</span>).fling()</span><br><span class="line"><span class="comment"># fling forward horizontally</span></span><br><span class="line">d(scrollable=<span class="literal">True</span>).fling.horiz.forward()</span><br><span class="line"><span class="comment"># fling backward vertically</span></span><br><span class="line">d(scrollable=<span class="literal">True</span>).fling.vert.backward()</span><br><span class="line"><span class="comment"># fling to beginning horizontally</span></span><br><span class="line">d(scrollable=<span class="literal">True</span>).fling.horiz.toBeginning(max_swipes=<span class="number">1000</span>)</span><br><span class="line"><span class="comment"># fling to end vertically</span></span><br><span class="line">d(scrollable=<span class="literal">True</span>).fling.toEnd()</span><br><span class="line"></span><br><span class="line"><span class="comment"># scroll forward(default) vertically(default)</span></span><br><span class="line">d(scrollable=<span class="literal">True</span>).scroll(steps=<span class="number">10</span>)</span><br><span class="line"><span class="comment"># scroll forward horizontally</span></span><br><span class="line">d(scrollable=<span class="literal">True</span>).scroll.horiz.forward(steps=<span class="number">100</span>)</span><br><span class="line"><span class="comment"># scroll backward vertically</span></span><br><span class="line">d(scrollable=<span class="literal">True</span>).scroll.vert.backward()</span><br><span class="line"><span class="comment"># scroll to beginning horizontally</span></span><br><span class="line">d(scrollable=<span class="literal">True</span>).scroll.horiz.toBeginning(steps=<span class="number">100</span>, max_swipes=<span class="number">1000</span>)</span><br><span class="line"><span class="comment"># scroll to end vertically</span></span><br><span class="line">d(scrollable=<span class="literal">True</span>).scroll.toEnd()</span><br><span class="line"><span class="comment"># scroll forward vertically until specific ui object appears</span></span><br><span class="line">d(scrollable=<span class="literal">True</span>).scroll.to(text=<span class="string">&quot;Security&quot;</span>)</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>WatchContext<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> d.watch_context() <span class="keyword">as</span> ctx:</span><br><span class="line">    ctx.when(<span class="string">&quot;^立即(下载|更新)&quot;</span>).when(<span class="string">&quot;取消&quot;</span>).click() <span class="comment"># 当同时出现 （立即安装 或 立即取消）和 取消 按钮的时候，点击取消</span></span><br><span class="line">    ctx.when(<span class="string">&quot;同意&quot;</span>).click()</span><br><span class="line">    ctx.when(<span class="string">&quot;确定&quot;</span>).click()</span><br><span class="line">    <span class="comment"># 上面三行代码是立即执行完的，不会有什么等待</span></span><br><span class="line">    </span><br><span class="line">    ctx.wait_stable() <span class="comment"># 开启弹窗监控，并等待界面稳定（两个弹窗检查周期内没有弹窗代表稳定）</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 使用call函数来触发函数回调</span></span><br><span class="line">    <span class="comment"># call 支持两个参数，d和el，不区分参数位置，可以不传参，如果传参变量名不能写错</span></span><br><span class="line">    <span class="comment"># eg: 当有元素匹配仲夏之夜，点击返回按钮</span></span><br><span class="line">    ctx.when(<span class="string">&quot;仲夏之夜&quot;</span>).call(<span class="keyword">lambda</span> d: d.press(<span class="string">&quot;back&quot;</span>))</span><br><span class="line">    ctx.when(<span class="string">&quot;确定&quot;</span>).call(<span class="keyword">lambda</span> el: el.click())</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 其他操作</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 为了方便也可以使用代码中默认的弹窗监控逻辑</span></span><br><span class="line"><span class="comment"># 下面是目前内置的默认逻辑，可以加群at群主，增加新的逻辑，或者直接提pr</span></span><br><span class="line">    <span class="comment"># when(&quot;继续使用&quot;).click()</span></span><br><span class="line">    <span class="comment"># when(&quot;移入管控&quot;).when(&quot;取消&quot;).click()</span></span><br><span class="line">    <span class="comment"># when(&quot;^立即(下载|更新)&quot;).when(&quot;取消&quot;).click()</span></span><br><span class="line">    <span class="comment"># when(&quot;同意&quot;).click()</span></span><br><span class="line">    <span class="comment"># when(&quot;^(好的|确定)&quot;).click()</span></span><br><span class="line"><span class="keyword">with</span> d.watch_context(builtin=<span class="literal">True</span>) <span class="keyword">as</span> ctx:</span><br><span class="line">    <span class="comment"># 在已有的基础上增加</span></span><br><span class="line">    ctx.when(<span class="string">&quot;@tb:id/jview_view&quot;</span>).when(<span class="string">&#x27;//*[@content-desc=&quot;图片&quot;]&#x27;</span>).click()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 其他脚本逻辑</span></span><br></pre></td></tr></table></figure></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ctx = d.watch_context()</span><br><span class="line">ctx.when(<span class="string">&quot;设置&quot;</span>).click()</span><br><span class="line">ctx.wait_stable() <span class="comment"># 等待界面不在有弹窗了</span></span><br><span class="line"></span><br><span class="line">ctx.close()</span><br></pre></td></tr></table></figure>

<ol start="8">
<li><p>全局设置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">d.HTTP_TIMEOUT = <span class="number">60</span> <span class="comment"># 默认值60s, http默认请求超时时间</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 当设备掉线时，等待设备在线时长，仅当TMQ=true时有效，支持通过环境变量 WAIT_FOR_DEVICE_TIMEOUT 设置</span></span><br><span class="line">d.WAIT_FOR_DEVICE_TIMEOUT = <span class="number">70</span> </span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(d.settings)</span><br><span class="line">&#123;<span class="string">&#x27;operation_delay&#x27;</span>: (<span class="number">0</span>, <span class="number">0</span>),</span><br><span class="line"> <span class="string">&#x27;operation_delay_methods&#x27;</span>: [<span class="string">&#x27;click&#x27;</span>, <span class="string">&#x27;swipe&#x27;</span>],</span><br><span class="line"> <span class="string">&#x27;wait_timeout&#x27;</span>: <span class="number">20.0</span>,</span><br><span class="line"> <span class="string">&#x27;xpath_debug&#x27;</span>: <span class="literal">False</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置点击前延时0.5s，点击后延时1s</span></span><br><span class="line">d.settings[<span class="string">&#x27;operation_delay&#x27;</span>] = (<span class="number">.5</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改延迟生效的方法</span></span><br><span class="line"><span class="comment"># 其中 double_click, long_click 都对应click</span></span><br><span class="line">d.settings[<span class="string">&#x27;operation_delay_methods&#x27;</span>] = [<span class="string">&#x27;click&#x27;</span>, <span class="string">&#x27;swipe&#x27;</span>, <span class="string">&#x27;drag&#x27;</span>, <span class="string">&#x27;press&#x27;</span>]</span><br><span class="line"></span><br><span class="line">d.settings[<span class="string">&#x27;xpath_debug&#x27;</span>] = <span class="literal">True</span> <span class="comment"># 开启xpath插件的调试日志</span></span><br><span class="line">d.settings[<span class="string">&#x27;wait_timeout&#x27;</span>] = <span class="number">20.0</span> <span class="comment"># 默认控件等待时间（原生操作，xpath插件的等待时间）</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>d.settings[<span class="string">&#x27;click_before_delay&#x27;</span>] = <span class="number">1</span>  </span><br><span class="line">[W <span class="number">200514</span> <span class="number">14</span>:<span class="number">55</span>:<span class="number">59</span> settings:<span class="number">72</span>] d.settings[click_before_delay] deprecated: Use operation_delay instead</span><br></pre></td></tr></table></figure></li>
<li><p>输入</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">d.set_fastinput_ime(<span class="literal">True</span>) <span class="comment"># 切换成FastInputIME输入法</span></span><br><span class="line">d.send_keys(<span class="string">&quot;你好123abcEFG&quot;</span>) <span class="comment"># adb广播输入</span></span><br><span class="line">d.clear_text() <span class="comment"># 清除输入框所有内容(Require android-uiautomator.apk version &gt;= 1.0.7)</span></span><br><span class="line">d.set_fastinput_ime(<span class="literal">False</span>) <span class="comment"># 切换成正常的输入法</span></span><br><span class="line">d.send_action(<span class="string">&quot;search&quot;</span>) <span class="comment"># 模拟输入法的搜索</span></span><br></pre></td></tr></table></figure></li>
<li><p>Toast</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">d.toast.show(<span class="string">&quot;Hello world&quot;</span>)</span><br><span class="line">d.toast.show(<span class="string">&quot;Hello world&quot;</span>, <span class="number">1.0</span>) <span class="comment"># show for 1.0s, default 1.0s</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [Args]</span></span><br><span class="line"><span class="comment"># 5.0: max wait timeout. Default 10.0</span></span><br><span class="line"><span class="comment"># 10.0: cache time. return cache toast if already toast already show up in recent 10 seconds. Default 10.0 (Maybe change in the furture)</span></span><br><span class="line"><span class="comment"># &quot;default message&quot;: return if no toast finally get. Default None</span></span><br><span class="line">d.toast.get_message(<span class="number">5.0</span>, <span class="number">10.0</span>, <span class="string">&quot;default message&quot;</span>)</span><br><span class="line"><span class="comment"># common usage</span></span><br><span class="line"><span class="keyword">assert</span> <span class="string">&quot;Short message&quot;</span> <span class="keyword">in</span> d.toast.get_message(<span class="number">5.0</span>, default=<span class="string">&quot;&quot;</span>)</span><br><span class="line"><span class="comment"># clear cached toast</span></span><br><span class="line">d.toast.reset()</span><br><span class="line"><span class="comment"># Now d.toast.get_message(0) is None</span></span><br></pre></td></tr></table></figure></li>
<li><p>XPath</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># wait exists 10s</span><br><span class="line">d.xpath(&quot;//android.widget.TextView&quot;).wait(10.0)</span><br><span class="line"># find and click</span><br><span class="line">d.xpath(&quot;//*[@content-desc=&#x27;分享&#x27;]&quot;).click()</span><br><span class="line"># check exists</span><br><span class="line">if d.xpath(&quot;//android.widget.TextView[contains(@text, &#x27;Se&#x27;)]&quot;).exists:</span><br><span class="line">    print(&quot;exists&quot;)</span><br><span class="line"># get all text-view text, attrib and center point</span><br><span class="line">for elem in d.xpath(&quot;//android.widget.TextView&quot;).all():</span><br><span class="line">    print(&quot;Text:&quot;, elem.text)</span><br><span class="line">    # Dictionary eg: </span><br><span class="line">    # &#123;&#x27;index&#x27;: &#x27;1&#x27;, &#x27;text&#x27;: &#x27;999+&#x27;, &#x27;resource-id&#x27;: &#x27;com.netease.cloudmusic:id/qb&#x27;, &#x27;package&#x27;: &#x27;com.netease.cloudmusic&#x27;, &#x27;content-desc&#x27;: &#x27;&#x27;, &#x27;checkable&#x27;: &#x27;false&#x27;, &#x27;checked&#x27;: &#x27;false&#x27;, &#x27;clickable&#x27;: &#x27;false&#x27;, &#x27;enabled&#x27;: &#x27;true&#x27;, &#x27;focusable&#x27;: &#x27;false&#x27;, &#x27;focused&#x27;: &#x27;false&#x27;,&#x27;scrollable&#x27;: &#x27;false&#x27;, &#x27;long-clickable&#x27;: &#x27;false&#x27;, &#x27;password&#x27;: &#x27;false&#x27;, &#x27;selected&#x27;: &#x27;false&#x27;, &#x27;visible-to-user&#x27;: &#x27;true&#x27;, &#x27;bounds&#x27;: &#x27;[661,1444][718,1478]&#x27;&#125;</span><br><span class="line">    print(&quot;Attrib:&quot;, elem.attrib)</span><br><span class="line">    # Coordinate eg: (100, 200)</span><br><span class="line">    print(&quot;Position:&quot;, elem.center())</span><br></pre></td></tr></table></figure></li>
<li><p>Screenrecord</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">d.screenrecord(<span class="string">&#x27;output.mp4&#x27;</span>)</span><br><span class="line"></span><br><span class="line">time.sleep(<span class="number">10</span>)</span><br><span class="line"><span class="comment"># or do something else</span></span><br><span class="line">d.screenrecord.stop() <span class="comment"># 停止录制后，output.mp4文件才能打开</span></span><br><span class="line"></span><br><span class="line">imdata = <span class="string">&quot;target.png&quot;</span> <span class="comment"># 也可以是URL, PIL.Image或OpenCV打开的图像</span></span><br><span class="line"></span><br><span class="line">d.image.match(imdata) </span><br><span class="line"><span class="comment"># 匹配待查找的图片，立刻返回一个结果</span></span><br><span class="line"><span class="comment"># 返回一个dict, eg: &#123;&quot;similarity&quot;: 0.9, &quot;point&quot;: [200, 300]&#125;</span></span><br><span class="line"></span><br><span class="line">d.image.click(imdata, timeout=<span class="number">20.0</span>)</span><br><span class="line"><span class="comment"># 在20s的时间内调用match轮询查找图片，当similarity&gt;0.9时，执行点击操作</span></span><br></pre></td></tr></table></figure></li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/05/29/ui2/" data-id="cl3r52on90000zcwx3pdf393e" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/" rel="tag">Android</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-JsBridge" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/05/21/JsBridge/" class="article-date">
  <time datetime="2022-05-21T02:19:58.000Z" itemprop="datePublished">2022-05-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/05/21/JsBridge/">【知识】【安卓】JsBridge</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>学习一个 H5 与安卓原生的交互方法 JsBridge</strong></p>
<h1 id="Js-调-Java"><a href="#Js-调-Java" class="headerlink" title="Js 调 Java"></a>Js 调 Java</h1><p>Java 创建 Handler</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">webView.registerHandler(&quot;hello&quot;, new BridgeHandler() &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void handler(String data, CallBackFunction function) &#123;</span><br><span class="line">        CusToast.showToast(&quot;hello:&quot; + data);</span><br><span class="line">        function.onCallBack(&quot;hi there&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>Js 指定 handler</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">function test() &#123;</span><br><span class="line">    var str = &quot;world&quot;;</span><br><span class="line"></span><br><span class="line">    //send message to native</span><br><span class="line">    var data = &#123;str&#125;;</span><br><span class="line">    window.WebViewJavascriptBridge.callHandler(&#x27;hello&#x27;</span><br><span class="line">        , &#123;&#x27;param&#x27;: data&#125;</span><br><span class="line">        , function(responseData) &#123;</span><br><span class="line">            document.getElementById(&quot;show&quot;).innerHTML = responseData;</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另一种不需要指定 Hanlder 的处理模式<br>Java 创建默认 Handler</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">webView.setDefaultHandler(new BridgeHandler() &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void handler(String data, CallBackFunction function) &#123;</span><br><span class="line">        CusToast.showToast(&quot;receive data:&quot; + data);</span><br><span class="line">        function.onCallBack(&quot;okay&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>Js 发消息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">function test() &#123;</span><br><span class="line">    var data = &quot;&quot;;</span><br><span class="line">    window.WebViewJavascriptBridge.send(</span><br><span class="line">            data</span><br><span class="line">            , function(responseData) &#123;</span><br><span class="line">                document.getElementById(&quot;show&quot;).innerHTML = &quot;repsonseData from java, data = &quot; + responseData</span><br><span class="line">            &#125;</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Java-调-Js"><a href="#Java-调-Js" class="headerlink" title="Java 调 Js"></a>Java 调 Js</h1><p>Js 创建 Hanlder</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">connectWebViewJavascriptBridge(function(bridge) &#123;</span><br><span class="line">    bridge.registerHandler(&quot;Jsfunc&quot;, function(data, responseCallback) &#123;</span><br><span class="line">        document.getElementById(&quot;init&quot;).innerHTML = (&quot;data: &quot; + data);</span><br><span class="line">        if (responseCallback) &#123;</span><br><span class="line">            var responseData = &quot;okay&quot;;</span><br><span class="line">            responseCallback(responseData);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>Java 指定 Handler</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">button.setOnClickListener(new View.OnClickListener() &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void onClick(View v) &#123;</span><br><span class="line">        webView.callHandler(&quot;Jsfunc&quot;, &quot;test data&quot;, new CallBackFunction() &#123;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">            public void onCallBack(String data) &#123;</span><br><span class="line">                CusToast.showToast(&quot;js resp: &quot; + data);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>同样有不指定 Hanlder 的模式<br>Js 创建</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">connectWebViewJavascriptBridge(function(bridge) &#123;</span><br><span class="line">    bridge.init(function(message, responseCallback) &#123;</span><br><span class="line">        console.log(&#x27;message:&#x27;, message);</span><br><span class="line">        var data = &quot;got it&quot;;</span><br><span class="line">        console.log(&#x27;JS resp: &#x27;, data);</span><br><span class="line">        responseCallback(data);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>Java 层</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">webView.send(&quot;message from Java&quot;, new CallBackFunction() &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void onCallBack(String data) &#123;</span><br><span class="line">        CusToast.showToast(&quot;Js resp: &quot; + data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>



      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/05/21/JsBridge/" data-id="cl3f98z1o00001cwx6hjy5ff7" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/" rel="tag">Android</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-policyLint" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/05/13/policyLint/" class="article-date">
  <time datetime="2022-05-13T06:15:17.000Z" itemprop="datePublished">2022-05-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/05/13/policyLint/">【技术】【安卓隐私合规】policyLint 工具原理解析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>最近在了解一些安卓隐私合规工作，主要想了解工作是如何基于 NLP 进行隐私政策文本处理的，因此记录一下经典之作 PolicyLint 的原理</p>
<h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>本文是发表于 Sec19 的<a target="_blank" rel="noopener" href="https://www.usenix.org/conference/usenixsecurity19/presentation/andow">PolicyLint: Investigating Internal Privacy Policy Contradictions on Google Play</a><br>这篇文章具体研究问题是，隐私政策文本内的一些表述矛盾，如同时在隐私政策内声明 <strong>我们不会收集您的个人信息</strong> 及 <strong>我们将收集您的手机号用于xxx</strong> ，这种情况被作者认为是隐私政策内部矛盾。</p>
<h1 id="Challenge"><a href="#Challenge" class="headerlink" title="Challenge"></a>Challenge</h1><ul>
<li><p>对信息的引用以不同的语义层次表达</p>
<ul>
<li>先前工作的术语假定关系需要指定，缺乏全面性及可扩展性</li>
<li>没有捕获推理隐私政策中提到的数据类型和实体所需的所有特定关系</li>
</ul>
</li>
<li><p>隐私政策包括负面分享和收集声明</p>
<ul>
<li>先前工作忽略负面声明</li>
<li>粒度粗无法处理复杂的陈述</li>
</ul>
</li>
</ul>
<h1 id="Insight"><a href="#Insight" class="headerlink" title="Insight"></a>Insight</h1><ol>
<li><p>句子结构 informs 语义<br>共享和收集语句通常遵循一组可学习的模板。PolicyLint 使用这些模板从这些语句中提取一个四元组：（参与者、动作、数据对象、实体）。<br><code>例如，我们 [Actor] 与广告商 [entity] 共享 [action] 个人信息 [data object]。</code><br>句子结构还可以更深入地了解更复杂的负面共享。<br><code>例如，“我们与广告商共享您的电子邮件地址以外的个人信息。”</code><br>PolicyLint 通过建立在现有的词性和依赖解析器之上，从隐私政策语句中提取此类语义。</p>
</li>
<li><p>隐私政策编码本体<br>由于隐私政策的法律性质，一般术语通常根据示例或其组成部分来定义。虽然可能不会为政策中使用的所有术语定义语义关系，但这些关系应该存在于我们数据集中的其他一些政策中。通过处理大量隐私政策，PolicyLint 自动生成特定于政策的本体（一个用于数据对象，一个用于实体）。PolicyLint 使用赫斯特模式 [16] 提取术语定义，我们已经将其扩展到我们的领域。</p>
</li>
</ol>
<h1 id="Design"><a href="#Design" class="headerlink" title="Design"></a>Design</h1><p><img src="/pics/policylint/design.png" alt="工具框架"></p>
<ol>
<li>Ontology Generation<br><strong>目标</strong>:在隐私政策中定义术语之间的推定（“is-a”）关系，以允许对不同粒度的语言进行推理<br><code>Example 1. We may share demographic information, such as your age and gender, with advertisers. </code><br>PolicyLint 使用这样的句子来自动发现大量隐私策略中的推定关系。 它侧重于数据对象和接收数据的实体。<br>PolicyLint 使用半自动化和数据驱动的技术来生成本体。它将本体生成分为三个主要部分。</li>
</ol>
<h2 id="NER-domain-adaption"><a href="#NER-domain-adaption" class="headerlink" title="NER domain adaption"></a>NER domain adaption</h2><p>PolicyLint 对现有的基于统计的命名实体识别 (NER) 模型进行 domain 适应。NER 用于标记句子中的数据对象和实体，不仅捕获术语，还捕获句子中的上下文。<br>为了识别数据对象及实体之间的假定关系，PL 需要识别词元代表的数据对象或实体。<br><code>例如上面的例子，[demographic information, age, gender] 会被识别为数据对象，[we, advertisers] 会被识别为实体。</code><br>NER（named-entity recognition）：基于统计的一种技术，用于标记句子中的数据对象及实体。</p>
<h2 id="Subsumptive-Relationship-Extraction"><a href="#Subsumptive-Relationship-Extraction" class="headerlink" title="Subsumptive Relationship Extraction"></a>Subsumptive Relationship Extraction</h2><p>PolicyLint 通过使用一组 11（？？在后续给出的表中只有九种，文章在这一节的开头似乎写错了） 种具有强制命名实体标签约束的词汇句法模式来学习标记数据对象和实体的假定关系。</p>
<p>PolicyLint 使用一组 9 种词汇句法模式来发现句子中的推定关系<br><img src="/pics/policylint/table2.png" alt="九种句式"><br>对每组 data object 和 entity。PolicyLint 通过对文本进行词形还原并用它们的同义词替换术语来规范化关系。</p>
<h3 id="同义词识别"><a href="#同义词识别" class="headerlink" title="同义词识别"></a>同义词识别</h3><p>人工做的。按照 data object 出现的频率输出，频率最高的词，如果其他 data object 包含他，这些 data object 一律标注。然后结合领域知识，将同义不同词的单词也标记。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">如，发现 location 这个词出现频率最高，那么其余任意包含 location 的词，输出，人工阅读，并将他们统一标记为 geographic location。</span><br><span class="line">然后利用领域知识得出 latitude and longitude 之类的表述也被标记为 geographic location</span><br></pre></td></tr></table></figure>

<h2 id="Ontology-Construction"><a href="#Ontology-Construction" class="headerlink" title="Ontology Construction"></a>Ontology Construction</h2><p>PolicyLint 将一组种子词作为输入，并使用在上一步中发现的假定关系生成数据对象/实体本体。 它迭代地将关系添加到本体，直到达到一个固定点。</p>
<p>一组 seed，找 seed 相关的 relationships，在这些 relationships 中继续找是否有其他表述的 data object，继续找这些 data object 相关的 relationships，直到没有新的。<br><img src="/pics/policylint/seed.png" alt="seed"></p>
<ol start="2">
<li>Policy Statement Extraction<br>将一条 policy statement 表示为 (actor, action, data object, entitiy)<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">如，we will share your personal information with advertisers --&gt; (we, share, personal information, advertisers)</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="DED-Data-and-Entity-Dependency-Tree-Construction"><a href="#DED-Data-and-Entity-Dependency-Tree-Construction" class="headerlink" title="DED(Data and Entity Dependency) Tree Construction"></a>DED(Data and Entity Dependency) Tree Construction</h2><p>PolicyLint 合并名词短语并迭代句子标记以标记 SoC 动词。确保词元的词性（part-of-speech）标签是动词并且动词的引理在 PolicyLint 的手动管理的术语列表中<br><img src="/pics/policylint/soc.png" alt="SoC Verbs"><br>PolicyLint 然后提取句子的基于依存关系的解析树，其节点用数据对象、实体和 SoC 动词标签进行标记。<br>DED 树会删除与数据对象、实体或 SoC 动词无关的节点和路径，并执行一组简化以概括表示。 </p>
<p><img src="/pics/policylint/ded.png" alt="DED Tree"></p>
<ul>
<li><strong>负面表达</strong> ：PolicyLint 通过检查基于依赖的分析树中的否定修饰符来识别否定动词。如果动词被否定，PolicyLint 将节点标记为负面情绪。 PolicyLint 在三种情况下将负面情绪传播到后代动词节点。<ul>
<li>如果后代动词是带有否定动词的连词动词短语的一部分，则会传播负面情绪。 “We do not sell, rent, or trade your personal information,” means “not sell,” “not rent,” and “not trade.”</li>
<li>如果后裔动词对否定动词有一个开放式从句补语，就会传播负面情绪。“We do not require you to disclose any personal information,” initially has “require” marked with negative sentiment. Since “disclose” is an open clausal complement to “require,” it is marked with negative sentiment. </li>
<li>如果后代动词是否定动词的状语从句修饰语，则会传播负面情绪。 例如，“我们不会收集您的信息以与广告商分享”，最初的“收集”标记为负面情绪。 由于“share”是“collect”的状语从句修饰语，“share”被标记为负面情绪。</li>
</ul>
</li>
<li><strong>例外表述</strong> ：含如 except、unless、aside、apart from、besides、without、not including 这类表例外情况的句子。<ul>
<li>对于每个已识别的异常子句，PolicyLint 从异常子句向下遍历分析树，以识别与该异常相关的动词短语（主语-动词-宾语）和名词短语。</li>
<li>PolicyLint 然后从异常项向上遍历以识别最近的动词节点，并将在向下遍历中识别的名词短语和动词短语列表附加为节点属性。</li>
<li>在某些情况下，该术语可能没有子树。例如，例外项可能是引入从句的标记。在“我们不会共享您的个人信息，除非得到同意”这句话中，除非”一词是引入从句“您的同意已获得”的标记。 对于空子树，PolicyLint 尝试从其父节点向下遍历。</li>
</ul>
</li>
</ul>
<h2 id="SoC-sharing-or-collection-Sentence-Identification"><a href="#SoC-sharing-or-collection-Sentence-Identification" class="headerlink" title="SoC(sharing or collection) Sentence Identification"></a>SoC(sharing or collection) Sentence Identification</h2><p>PolicyLint 遍历每个句子。如果句子包含至少一个 SoC 动词和数据对象（由 NER 标记），则 构建 DED 树，将句子的 DED 树与每个已知模式的 DED 树进行比较。<br>（1）句子的 DED 树的标签类型等同于已知模式的 DED 树的标签类型（例如，{entity, SoC_verb, data}）<br>（2）已知模式的 DED 树是句子的 DED 树的子树</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/05/13/policyLint/" data-id="cl342hsyw00016swxgjex4xj9" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android%E9%9A%90%E7%A7%81/" rel="tag">Android隐私</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-pythoncmdadb" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/05/13/pythoncmdadb/" class="article-date">
  <time datetime="2022-05-13T05:59:32.000Z" itemprop="datePublished">2022-05-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/05/13/pythoncmdadb/">【技术】【adb】python 脚本在 cmd 控制 adb</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>由于最近需要写脚本，控制 cmd 执行 adb 指令，但是 Android 环境是 magisk root 的 Android 10，所以直接在 cmd 无法用 adb 执行需要 root 权限的指令（adbd cannot run as root in production builds），试了改 ro.debuggable 和 ro.secure 都不行，于是找到了如下解决方案。实现 __python 脚本在 cmd 执行 adb 那些需要 root 的指令的方法__。</p>
<h1 id="法1-脚本在-cmd-执行-adb-普通指令"><a href="#法1-脚本在-cmd-执行-adb-普通指令" class="headerlink" title="法1 脚本在 cmd 执行 adb 普通指令"></a>法1 脚本在 cmd 执行 adb 普通指令</h1><p>如，直接脚本运行 adb shell logcat | grep xxx 会报错 grep，可以借助</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import os</span><br><span class="line">adbCmd = &#x27;adb shell &quot;logcat | grep xxx&quot;&#x27;</span><br><span class="line">os.popen(adbCmd)</span><br></pre></td></tr></table></figure>

<h1 id="法2-脚本在-cmd-执行-adb-root-指令"><a href="#法2-脚本在-cmd-执行-adb-root-指令" class="headerlink" title="法2 脚本在 cmd 执行 adb root 指令"></a>法2 脚本在 cmd 执行 adb root 指令</h1><p>上述有些指令需要 adb root，但是 adb shell 只能在进入后依靠 <code>su</code> 进入 root，要靠如下指令实现</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import os</span><br><span class="line">adbCmd = &#x27;adb shell &quot;su -c am start -n xxx.xx/.xActivity&quot;&#x27;</span><br><span class="line">os.popen(adbCmd)</span><br></pre></td></tr></table></figure>

<h1 id="法3-脚本在-cmd-执行多行-adb-指令-进入-adb-shell"><a href="#法3-脚本在-cmd-执行多行-adb-指令-进入-adb-shell" class="headerlink" title="法3 脚本在 cmd 执行多行 adb 指令/进入 adb shell"></a>法3 脚本在 cmd 执行多行 adb 指令/进入 adb shell</h1><p>有时执行一条指令不够</p>
<h2 id="法3-1"><a href="#法3-1" class="headerlink" title="法3.1"></a>法3.1</h2><p>通过 &amp;&amp; 连接多个 cmd 语句，从而达到执行多行 adb 语句</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adbCmd = &#x27;adb shell &quot;logcat | grep xxx&quot; &amp;&amp; adb shell &quot;su -c am start -n xxx/.xActivity&quot;&#x27;</span><br></pre></td></tr></table></figure>

<h2 id="法3-2"><a href="#法3-2" class="headerlink" title="法3.2"></a>法3.2</h2><p>靠脚本控制 cmd 进入 adb shell，体验感与直接在 cmd 进入 adb shell 最相似的方案</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">import subprocess</span><br><span class="line">handler = subprocess.Popen(&quot;adb shell&quot;, stdout = subprocess.PIPE, stdin = subprocess.PIPE)</span><br><span class="line">handler.stdin.write(b&quot;su\n&quot;)</span><br><span class="line">handler.stdin.write(b&quot;am start xxx.xx/xActivity&quot;)</span><br><span class="line">hanlder.stdin.close()</span><br><span class="line">for output_line in handler.stdout.readlines():</span><br><span class="line">    print(output_line)</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/05/13/pythoncmdadb/" data-id="cl342hsys00006swx3f4ofaqy" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/" rel="tag">Android</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-unpackwxError" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/04/22/unpackwxError/" class="article-date">
  <time datetime="2022-04-22T02:54:08.000Z" itemprop="datePublished">2022-04-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/04/22/unpackwxError/">【技术】【小程序】wxUnpacker 工具“SyntaxError： Illegal return statement” 错误</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>之前提到的微信小程序解包工具，在部分小程序上无法正常反编译，表现在输出结果上为得不到页面 wxml 及 wxss 文件。</p>
<h1 id="Error-解决"><a href="#Error-解决" class="headerlink" title="Error 解决"></a>Error 解决</h1><h2 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h2><p>脚本解包过程中断，控制台输出</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">vm.js:519</span><br><span class="line"></span><br><span class="line">return function(env,dd,global)&#123;$gwxc=0;var root=&#123;&quot;tag&quot;:&quot;wx-page&quot;&#125;;root.children=[]</span><br><span class="line"></span><br><span class="line">^^^^^^</span><br><span class="line"></span><br><span class="line">SyntaxError: Illegal return statement</span><br><span class="line">    at VMScript.compile (/home/wq57885/wxappUnpacker/node_modules/vm2/lib/main.js:80:20)</span><br><span class="line">    at VM.run (/home/wq57885/wxappUnpacker/node_modules/vm2/lib/main.js:215:10)</span><br><span class="line">    at z (/home/wq57885/wxappUnpacker/wuWxml.js:366:7)</span><br><span class="line">    at z (/home/wq57885/wxappUnpacker/wuRestoreZ.js:244:17)</span><br><span class="line">    at catchZGroup (/home/wq57885/wxappUnpacker/wuRestoreZ.js:15:2)</span><br><span class="line">    at catchZ (/home/wq57885/wxappUnpacker/wuRestoreZ.js:19:29)</span><br><span class="line">    at getZ (/home/wq57885/wxappUnpacker/wuRestoreZ.js:244:2)</span><br><span class="line">    at wu.get.code (/home/wq57885/wxappUnpacker/wuWxml.js:354:3)</span><br><span class="line">    at ioLimit.runWithCb (/home/wq57885/wxappUnpacker/wuLib.js:80:8)</span><br><span class="line">    at agent (/home/wq57885/wxappUnpacker/wuLib.js:54:14)</span><br></pre></td></tr></table></figure>

<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>总的来说这个问题是由于小程序包结构随版本更新有变化，导致前一位大佬的 wxUnpacker 没法正确解析 wxml 及 wxss 文件，为此 19 年另一位大佬提供了解决工具<a target="_blank" rel="noopener" href="https://github.com/larack8/wxappUnpacker">larack8</a>。</p>
<h2 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h2><p>拜读了大佬解决问题的逻辑，主要如下</p>
<h3 id="原工具解析思路"><a href="#原工具解析思路" class="headerlink" title="原工具解析思路"></a>原工具解析思路</h3><p>所有在 wxapkg 包中的 html 文件都调用了setCssToHead函数，其代码如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">var setCssToHead = function(file, _xcInvalid) &#123;</span><br><span class="line">    var Ca = &#123;&#125;;</span><br><span class="line">    var _C = [...arrays...];</span><br><span class="line">    function makeup(file, suffix) &#123;</span><br><span class="line">        var _n = typeof file === &quot;number&quot;;</span><br><span class="line">        if (_n &amp;&amp; Ca.hasOwnProperty(file)) return &quot;&quot;;</span><br><span class="line">        if (_n) Ca[file] = 1;</span><br><span class="line">        var ex = _n ? _C[file] : file;</span><br><span class="line">        var res = &quot;&quot;;</span><br><span class="line">        for (var i = ex.length - 1; i &gt;= 0; i--) &#123;</span><br><span class="line">            var content = ex[i];</span><br><span class="line">            if (typeof content === &quot;object&quot;) &#123;</span><br><span class="line">                var op = content[0];</span><br><span class="line">                if (op == 0) res = transformRPX(content[1]) + &quot;px&quot; + res; else if (op == 1) res = suffix + res; else if (op == 2) res = makeup(content[1], suffix) + res;</span><br><span class="line">            &#125; else res = content + res;</span><br><span class="line">        &#125;</span><br><span class="line">        return res;</span><br><span class="line">    &#125;</span><br><span class="line">    return function(suffix, opt) &#123;</span><br><span class="line">        if (typeof suffix === &quot;undefined&quot;) suffix = &quot;&quot;;</span><br><span class="line">        if (opt &amp;&amp; opt.allowIllegalSelector != undefined &amp;&amp; _xcInvalid != undefined) &#123;</span><br><span class="line">            if (opt.allowIllegalSelector) console.warn(&quot;For developer:&quot; + _xcInvalid); else &#123;</span><br><span class="line">                console.error(_xcInvalid + &quot;This wxss file is ignored.&quot;);</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Ca = &#123;&#125;;</span><br><span class="line">        css = makeup(file, suffix);</span><br><span class="line">        var style = document.createElement(&quot;style&quot;);</span><br><span class="line">        var head = document.head || document.getElementsByTagName(&quot;head&quot;)[0];</span><br><span class="line">        style.type = &quot;text/css&quot;;</span><br><span class="line">        if (style.styleSheet) &#123;</span><br><span class="line">            style.styleSheet.cssText = css;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            style.appendChild(document.createTextNode(css));</span><br><span class="line">        &#125;</span><br><span class="line">        head.appendChild(style);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>阅读这段代码可知，它把 wxss 代码拆分成几段数组，数组中的内容可以是一段将要作为 css 文件的字符串，也可以是一个表示 这里要添加一个公共后缀 或 这里要包含另一段代码 或 要将以 wxss 专供的 rpx 单位表达的数字换算成能由浏览器渲染的 px 单位所对应的数字 的数组。</p>
<p>同时，它还将所有被@import引用的 wxss 文件所对应的数组内嵌在该函数中的 _C 变量中。</p>
<p>我们可以修改setCssToHead，然后执行所有的setCssToHead，第一遍先判断出 _C 变量中所有的内容是哪个要被引用的 wxss 提供的，第二遍还原所有的 wxss。值得注意的是，可能出于兼容性原因，微信为很多属性自动补上含有-webkit-开头的版本，另外几乎所有的 tag 都加上了wx-前缀，并将page变成了body。通过一些 CSS 的 AST ，例如 CSSTree，我们可以去掉这些东西。</p>
<p><strong>wxs</strong><br>在 page-frame.html ( 或 app-wxss.js ) 中，我们找到了这样的内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">f_[&#x27;a/comm.wxs&#x27;] = nv_require(&quot;p_a/comm.wxs&quot;);</span><br><span class="line">function np_0()&#123;var nv_module=&#123;nv_exports:&#123;&#125;&#125;;nv_module.nv_exports = (&#123;nv_bar:nv_some_msg,&#125;);return nv_module.nv_exports;&#125;</span><br><span class="line"></span><br><span class="line">f_[&#x27;b/comm.wxs&#x27;] = nv_require(&quot;p_b/comm.wxs&quot;);</span><br><span class="line">function np_1()&#123;var nv_module=&#123;nv_exports:&#123;&#125;&#125;;nv_module.nv_exports = (&#123;nv_bar:nv_some_msg,&#125;);return nv_module.nv_exports;&#125;</span><br><span class="line"></span><br><span class="line">f_[&#x27;b/index.wxml&#x27;]=&#123;&#125;;</span><br><span class="line">f_[&#x27;b/index.wxml&#x27;][&#x27;foo&#x27;] =nv_require(&quot;m_b/index.wxml:foo&quot;);</span><br><span class="line">function np_2()&#123;var nv_module=&#123;nv_exports:&#123;&#125;&#125;;var nv_some_msg = &quot;hello world&quot;;nv_module.nv_exports = (&#123;nv_msg:nv_some_msg,&#125;);return nv_module.nv_exports;&#125;</span><br><span class="line">f_[&#x27;b/index.wxml&#x27;][&#x27;some_comms&#x27;] =f_[&#x27;b/comm.wxs&#x27;] || nv_require(&quot;p_b/comm.wxs&quot;);</span><br><span class="line">f_[&#x27;b/index.wxml&#x27;][&#x27;some_comms&#x27;]();</span><br><span class="line">f_[&#x27;b/index.wxml&#x27;][&#x27;some_commsb&#x27;] =f_[&#x27;a/comm.wxs&#x27;] || nv_require(&quot;p_a/comm.wxs&quot;);</span><br><span class="line">f_[&#x27;b/index.wxml&#x27;][&#x27;some_commsb&#x27;]();</span><br></pre></td></tr></table></figure>

<p>可以看出微信将内嵌和外置的 wxs 都转译成np_%d函数，并由f_数组来描述他们。转译的主要变换是调用的函数名称都加上了nv_前缀。在不严谨的场合，我们可以直接通过文本替换去除这些前缀。</p>
<p><strong>wxml</strong><br>相比其他内容，这一段比较复杂，因为微信将原本 类 xml 格式的 wxml 文件直接编译成了 js 代码放入 page-frame.html ( 或 app-wxss.js ) 中，之后通过调用这些代码来构造 virtual-dom，进而渲染网页。 首先，微信将所有要动态计算的变量放在了一个由函数构造的z数组中，构造部分代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(function(z)&#123;var a=11;function Z(ops)&#123;z.push(ops)&#125;</span><br><span class="line">Z([3,&#x27;index&#x27;]);</span><br><span class="line">Z([[8],&#x27;text&#x27;,[[4],[[5],[[5],[[5],[1,1]],[1,2]],[1,3]]]]);</span><br><span class="line">&#125;)(z);</span><br></pre></td></tr></table></figure>

<p>其实可以将[[id],xxx,yyy]看作由指令与操作数的组合。注意每个这样的数组作为指令所产生的结果会作为外层数组中的操作数，这样可以构成一个树形结构。通过将递归计算的过程改成拼接源代码字符串的过程，我们可以还原出每个数组所对应的实际内容（值得注意的是，由于微信的Token解析程序采用了贪心算法，我们必须将连续的}翻译为} }而非}}，否则会被误认为是Mustache的结束符）。下文中，将这个数组中记为z。</p>
<p>然后，对于 wxml 文件的结构，可以将每种可能的 js 语句拆分成 指令 来分析，这里可以用到 Esprima 这样的 js 的 AST 来简化识别操作，可以很容易分析出以下内容，例如:</p>
<ul>
<li>var {name}=_n(‘{tag}’) 创建名称为{name}， tag 为{tag}的节点。</li>
<li>_r({name},’{attrName}’,{id},e,s,gg) 将{name}的{attrName}属性修改为z[{id}]的值。</li>
<li>_({parName},{name}) 将{name}作为{parName}的子节点。</li>
<li>var {name}=_o({id},..,..,..) 创建名称为{name}，内容为z[{id}]的文本节点。</li>
<li>var {name}=_v() 创建名称为{name}的虚节点( wxml 里恰好提供了功能相当的虚结点block, 这句话相当于var {name}=_n(‘block’))。</li>
<li>var {name}=_m(‘{tag}’,[‘{attrName1}’,{id1},’{attrName2}’,{id2},…],[],..,..,..) 创建名称为{name}， tag 为{tag}的节点，同时将{attrNameX}属性修改为z[f({idX})]的值(f定义为{idX}与{base}的和；{base}初始为0，f返回的第一个正值后{base}即改为该返回值；若返回负值，表示该属性无值)。</li>
<li>return {name} 名称为{name}的节点设为主节点。</li>
<li>cs.*** 调试用语句，无视之。</li>
</ul>
<p>此外wx:if结构和wx:for可做递归处理。例如，对于如下wx:if结构:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">var &#123;name&#125;=_v()</span><br><span class="line">_(&#123;parName&#125;,&#123;name&#125;)</span><br><span class="line">if(_o(&#123;id1&#125;,e,s,gg))&#123;oD.wxVkey=1</span><br><span class="line">//content1</span><br><span class="line">&#125;</span><br><span class="line">else if(_o(&#123;id2&#125;,e,s,gg))&#123;oD.wxVkey=2</span><br><span class="line">//content2</span><br><span class="line">&#125;</span><br><span class="line">else&#123;oD.wxVkey=3</span><br><span class="line">//content3</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>相当于将以下节点放入{parName}节点下(z[{id1}]应替换为对应的z数组中的值)：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;block wx:if=&quot;z[&#123;id1&#125;]&quot;&gt;</span><br><span class="line">    &lt;!--content1--&gt;</span><br><span class="line">&lt;/block&gt;</span><br><span class="line">&lt;block wx:elif=&quot;z[&#123;id2&#125;]&quot;&gt;</span><br><span class="line">    &lt;!--content2--&gt;</span><br><span class="line">&lt;/block&gt;</span><br><span class="line">&lt;block wx:else&gt;</span><br><span class="line">    &lt;!--content3--&gt;</span><br><span class="line">&lt;/block&gt;</span><br></pre></td></tr></table></figure>

<p>具体实现中可以将递归时创建好多个block，调用子函数时指明将放入{name}下(_({name},{son}))识别为放入对应{block}下。wx:for也可类似处理，例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">具体实现中可以将递归时创建好多个block，调用子函数时指明将放入&#123;name&#125;下(_(&#123;name&#125;,&#123;son&#125;))识别为放入对应&#123;block&#125;下。wx:for也可类似处理，例如：</span><br></pre></td></tr></table></figure>

<p>对应(z[{id1}]应替换为对应的z数组中的值)：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;view wx:for=&quot;&#123;z[&#123;id&#125;]&#125;&quot; wx:for-item=&quot;&#123;item&#125;&quot; wx:for-index=&quot;&#123;index&#125;&quot; wx:key=&quot;&#123;key&#125;&quot;&gt;</span><br><span class="line">    &lt;!--content--&gt;</span><br><span class="line">&lt;/view&gt;</span><br></pre></td></tr></table></figure>

<p>调用子函数时指明将放入{fakeRoot}下(_({fakeRoot},{son}))识别为放入{name}下。除此之外，有时我们还要将一组代码标记为一个指令，例如下面：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">var lK=_v()</span><br><span class="line">_(&#123;parName&#125;,lK)</span><br><span class="line">var aL=_o(&#123;isId&#125;,e,s,gg)</span><br><span class="line">var tM=_gd(x[0],aL,e_,d_)</span><br><span class="line">if(tM)&#123;</span><br><span class="line">var eN=_1(&#123;dataId&#125;,e,s,gg) || &#123;&#125;</span><br><span class="line">var cur_globalf=gg.f</span><br><span class="line">lK.wxXCkey=3</span><br><span class="line">tM(eN,eN,lK,gg)</span><br><span class="line">gg.f=cur_globalf</span><br><span class="line">&#125;</span><br><span class="line">else _w(aL,x[0],11,26)</span><br></pre></td></tr></table></figure>

<p>对应于{parName}下添加如下节点:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;template is=&quot;z[&#123;isId&#125;]&quot; data=&quot;z[&#123;dataId&#125;]&quot;&gt;&lt;/template&gt;</span><br></pre></td></tr></table></figure>

<p>还有import和include的代码比较分散，但其实只要抓住重点的一句话就可以了，例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">var &#123;name&#125;=e_[x[&#123;to&#125;]].i</span><br><span class="line">//Other code</span><br><span class="line">_ai(&#123;name&#125;,x[&#123;from&#125;],e_,x[&#123;to&#125;],..,..)</span><br><span class="line">//Other code</span><br><span class="line">&#123;name&#125;.pop()</span><br></pre></td></tr></table></figure>

<p>对应与(其中的x是直接定义在 page-frame.html ( 或 app-wxss.js ) 中的字符串数组)：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;import src=&quot;x[&#123;from&#125;]&quot; /&gt;</span><br></pre></td></tr></table></figure>

<p>而include类似：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">var &#123;name&#125;=e_[x[0]].j</span><br><span class="line">//Other code</span><br><span class="line">_ic(x[&#123;from&#125;],e_,x[&#123;to&#125;],..,..,..,..);</span><br><span class="line">//Other code</span><br><span class="line">&#123;name&#125;.pop()</span><br></pre></td></tr></table></figure>

<p>对应与：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;include src=&quot;x[&#123;from&#125;]&quot; /&gt;</span><br></pre></td></tr></table></figure>

<p>可以看到我们可以在处理时忽略前后两句话，把中间的_ic和_ai处理好就行了。通过解析 js 把 wxml 大概结构还原后，可能相比编译前的 wxml 显得臃肿，可以考虑自动简化，例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;block wx:if=&quot;xxx&quot;&gt;</span><br><span class="line">    &lt;view&gt;</span><br><span class="line">        &lt;!--content--&gt;</span><br><span class="line">    &lt;/view&gt;</span><br><span class="line">&lt;/block&gt;</span><br></pre></td></tr></table></figure>

<p>可简化为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;view wx:if=&quot;xxx&quot;&gt;</span><br><span class="line">    &lt;!--content--&gt;</span><br><span class="line">&lt;/view&gt;</span><br></pre></td></tr></table></figure>

<h3 id="更新后"><a href="#更新后" class="headerlink" title="更新后"></a>更新后</h3><p>wcc-v0.5vv_20180626_syb_zp后通过只加载z数组中需要的部分来提高小程序运行速度，这也会导致仅考虑到上述内容的解包程序解包失败，这一更新的主要内容如下：</p>
<ul>
<li>增加z数组的函数:_rz _2z _mz _1z _oz</li>
<li>在每个函数头部增加了var z=gz$gwx_{$id}()，来标识使用的z数组id</li>
<li>原有的z数组不再存在</li>
<li>z数组已以下固定格式出现：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">function gz$gwx_&#123;$id&#125;()&#123;</span><br><span class="line">if( __WXML_GLOBAL__.ops_cached.$gwx_&#123;$id&#125;)return __WXML_GLOBAL__.ops_cached.$gwx_&#123;$id&#125;</span><br><span class="line">__WXML_GLOBAL__.ops_cached.$gwx_&#123;$id&#125;=[];</span><br><span class="line">(function(z)&#123;var a=11;function Z(ops)&#123;z.push(ops)&#125;</span><br><span class="line"></span><br><span class="line">//... (Z(&#123;$content&#125;))</span><br><span class="line"></span><br><span class="line">&#125;)(__WXML_GLOBAL__.ops_cached.$gwx_&#123;$id&#125;);return __WXML_GLOBAL__.ops_cached.$gwx_&#123;$id&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于上述变更，将获取z数组处修改并添加对_rz _2z _mz _1z _oz的支持即可。需要注意的是开发版的z数组转为如下结构：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(function(z)&#123;var a=11;function Z(ops,debugLine)&#123;z.push([&#x27;11182016&#x27;,ops,debugLine])&#125;</span><br><span class="line">//...</span><br><span class="line">&#125;)//...</span><br></pre></td></tr></table></figure>

<p>探测到为开发版后应将获取到的z数组仅保留数组中的第二项。以及含分包的子包采用 gz$gwx{$subPackageId}_{$id} 命名，其中{$subPackageId}是一个数字。另外还需要注意，template的 var z=gz$gwx_{$id} 在try块外。</p>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>其余一些博客提到利用 larack8 大佬的工具解决问题后，还存在找不到 node 模块的问题，他们给的解决方案相同，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm install -g n</span><br><span class="line">n latest</span><br><span class="line">npm update -g</span><br></pre></td></tr></table></figure>
<p>然后再把所有需要的包 install 一遍。</p>
<p>这边用这个方法并没有解决问题，其次私以为该错误的根本问题还是 node 环境本身，问题在nodejs怎么查找模块上。</p>
<ul>
<li>首先，要知道 npm 全局安装到底把模块安装到了哪个目录下面。在终端运行npm prefix -g命令会打印出安装路径。而nodejs查找模块是在module.paths目录列表下面查找的。</li>
<li>所以，一种解决方案是在程序中将npm全局安装路径添加到module.paths中。module.paths.push(‘全局安装路径’)。然后再测试可行。这种方案只对当前js有效。</li>
<li>另一种是添加环境变量NODE_PATH，值就设置成全局安装路径。如图中所示，添加后测试可行。</li>
<li>其实，添加环境变量NODE_PATH后，我们再去查看module.paths时会发现环境变量中的路径也已经在module.paths中了。所以，最方便的解决办法就是：npm prefix -g 找到全局安装的路径，然后添加到环境变量NODE_PATH中。</li>
</ul>
<p>解决 require 问题之后再统一安装 wxUnpacker-larack8 ver 需要的模块即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">npm install uglify-es --save</span><br><span class="line">npm install esprima  --save</span><br><span class="line">npm install css-tree  --save</span><br><span class="line">npm install cssbeautify --save</span><br><span class="line">npm install vm2  --save</span><br><span class="line">npm install uglify-es  --save</span><br><span class="line">npm install js-beautify  --save</span><br><span class="line">npm install escodegen  --save</span><br><span class="line">npm install cheerio  --save</span><br></pre></td></tr></table></figure>


<p>参考资料<br><a target="_blank" rel="noopener" href="https://github.com/larack8/wxappUnpacker">https://github.com/larack8/wxappUnpacker</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/wq57885/article/details/101113017">https://blog.csdn.net/wq57885/article/details/101113017</a><br><a target="_blank" rel="noopener" href="https://jingyan.baidu.com/article/2d5afd6937ad7785a2e28e98.html">https://jingyan.baidu.com/article/2d5afd6937ad7785a2e28e98.html</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/04/22/unpackwxError/" data-id="cl29vn5f00000ocwx7uvhe0o7" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%B0%8F%E7%A8%8B%E5%BA%8F/" rel="tag">小程序</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-apinath" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/04/15/apinath/" class="article-date">
  <time datetime="2022-04-15T01:12:12.000Z" itemprop="datePublished">2022-04-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/04/15/apinath/">【技术】【小程序】Apinat 工具原理解析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>最近需要研究小程序 API 与调用到的 Android API 映射的问题，因此研究文章<a target="_blank" rel="noopener" href="https://dl.acm.org/doi/abs/10.1145/3372297.3417255">CCS20 Haoran Lu</a>中 <a target="_blank" rel="noopener" href="https://sites.google.com/view/appinapp/automatic-analysis-tool">Apinat</a> 工具原理，并在微信 7.0.20 版本上实现。</p>
<h1 id="Apinat"><a href="#Apinat" class="headerlink" title="Apinat"></a>Apinat</h1><h2 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h2><p>在小程序中调用小程序 API，给出为实现该小程序 API，Java 层实现所用到的 Android API。作者开发本工具的目的是为了找到没有被微信小程序权限保护（scope.xxx）但是底层实现的 Android API被 AOSP dangerous permission 保护的那些小程序 API，这些小程序 API 被称为 Encapsulated API。详见前文<a target="_blank" rel="noopener" href="https://jwy630.github.io/2022/03/11/paperCCS20/">paper summary CCS20</a>。</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><h3 id="背景知识"><a href="#背景知识" class="headerlink" title="背景知识"></a>背景知识</h3><p>Dispatch function（wx api）线程不直接调用 Android API，而是触发新的线程来调用 Android API，这么实现可能是出于不阻塞 dispatch 线程的考虑。<br>这就导致 dispatch 在 Thread1，实际执行的 Android APIs 在 Thread2。</p>
<h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p>因此这就需要解决一个问题，就是处理多线程环境，将相关 threads 联系起来。</p>
<h3 id="解决思路"><a href="#解决思路" class="headerlink" title="解决思路"></a>解决思路</h3><p>通常 dispatch thread 会使用 Handler 机制（微信是这样，其他小程序平台如支付宝可能用的其他机制）来触发多线程。因此只需要基于 Handler 机制的推送及处理消息的原理就可以将线程联系起来。</p>
<ul>
<li>Triggering Thread：有 handler 实例，通过调用 handler.post(runnable) 来向消息队列提交一个 runnable</li>
<li>Handler thread：将 runnable 从队列拿出，并执行</li>
<li>如果 handler thread 中处理的 runnable 与 triggering thread 添加到队列的 runnable 相同，则可以将两个线程连接。</li>
</ul>
<h3 id="实现-1"><a href="#实现-1" class="headerlink" title="实现"></a>实现</h3><p>本实现基于前面提到的 <a target="_blank" rel="noopener" href="https://sites.google.com/view/appinapp/automatic-analysis-tool">Apinat</a> 提供的参考代码有修改，因为作者给出的代码没有指明在何版本微信上运行，因此笔者在参考工具框架基础上，结合微信 7.0.20 版本的小程序 API 调用的 Handler 实现而修改开发了适用 7.0.20 版本微信的 Apinat 工具，后续 8.x.x 版本应该也可用，只要 Handler 实现原理不变就适用。</p>
<ol>
<li><p>工具代码中 hook 的 apk 版本未给出，因此需要根据实际测试的微信 apk 版本修改。具体修改项：Xp_demo.java 中的 “com.tencent.mm.plugin.appbrand.jsapi.d” 类中被 hook 的是 “y” 方法，改方法是逆向对应的 7.0.20 中小程序 API invokeHandler 处理后必调方法。（原本这里是“n”，对应的是作者分析的未知版本的微信 apk）。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">XposedHelpers.findAndHookMethod(</span><br><span class="line">  //7.0.20 d 类的 y 方法</span><br><span class="line">  &quot;com.tencent.mm.plugin.appbrand.jsapi.d&quot;, lpparam.classLoader, &quot;y&quot;, String.class, String.class, int.class,// 被Hook函数的名称</span><br><span class="line">  new XC_MethodHook() &#123;</span><br><span class="line">      @Override</span><br><span class="line">      protected void afterHookedMethod(MethodHookParam param)</span><br><span class="line">              throws Throwable &#123;</span><br><span class="line">          String tag = &quot;[Dump Stack]&quot;;</span><br><span class="line">          String msg = &quot;=====miniAppApi&quot; + String.valueOf(param.args[0]) + &quot;*******&quot;;</span><br><span class="line">          printLog(tag,msg);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li>
<li><p>hook 到小程序 thread 的 handler post<br>原代码是 hook android.os.Handler.getPostMessage，可能是微信 apk 版本不同，7.0.20 中是通过 handler.post(runnable)，因此 hook 作者给出的 getPostMessage 拿不到任何调用信息，hook handler.post 方法有信息，并且检查调用栈可以找到上述 jsapi.d.a 方法。通过 hook 并进行调用栈筛选可以拿到 __实现小程序 API 的 runnable 实例__。</p>
</li>
<li><p>hook handler 的消息处理函数<br>作者 hook 的是 handleCallback，笔者认为应该是基于 handler.dispatchMessage 中下列代码的考虑</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// dispatchMessage 内部</span><br><span class="line">if(message.callback)&#123;</span><br><span class="line">  handleCallback(message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因此作者的 hook 代码为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// 作者 hook 并做了 message.what != 0 的过滤</span><br><span class="line">// hook android.os.Handler.handleCallback</span><br><span class="line">if(message.what == 0) return;</span><br></pre></td></tr></table></figure>
<p>但是这里 hook 不到任何东西，因为这里想 hook 的消息处理逻辑跟前面的 getPostMessage 是对应的，因为在那种情况下 message.what 是对应的处理线程 id，但是如果是用 handler.post 的话会直接回调运行 runnable.run 代码，因此 message.what 不是 threadId，而是 0（调度线程id），所以即使 hook 到也会被第二行 if(message.what == 0) 判断过滤掉，所以笔者修改 hook 函数为为 android.os.Handler.dispatchMessage，修改筛选条件为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// hook android.os.Handler.dispatchMessage</span><br><span class="line">if(message.callback == null)&#123;</span><br><span class="line">  return</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>hook Android API<br>这个就不多说了，正常 hook 系统 API 并打印</p>
</li>
<li><p>Log 处理<br>Hook 到的以上信息都打印在 log 中，还需要后续追加对 log 处理，但是逻辑很简单，就是提取上述四个信息，构建（小程序 API thread —- runnable 实例 name —- 处理含 runnable 实例的 Handler thread —- 该 Handler Thread 的 Android API 调用），即可得到 __小程序 API  —- Android API Mapping__。</p>
</li>
</ol>
<h3 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br></pre></td><td class="code"><pre><span class="line">package com.example.a91377.xpdemo;</span><br><span class="line"></span><br><span class="line">import android.app.Application;</span><br><span class="line">import android.content.Context;</span><br><span class="line">import android.location.Location;</span><br><span class="line">import android.location.LocationManager;</span><br><span class="line">import android.net.wifi.WifiManager;</span><br><span class="line">import android.os.Message;</span><br><span class="line">import android.telephony.TelephonyManager;</span><br><span class="line">import android.util.Log;</span><br><span class="line"></span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line">import java.lang.reflect.Modifier;</span><br><span class="line">import java.util.ArrayList;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">import de.robv.android.xposed.IXposedHookLoadPackage;</span><br><span class="line">import de.robv.android.xposed.XC_MethodHook;</span><br><span class="line">import de.robv.android.xposed.XC_MethodReplacement;</span><br><span class="line">import de.robv.android.xposed.XposedBridge;</span><br><span class="line">import de.robv.android.xposed.XposedHelpers;</span><br><span class="line">import de.robv.android.xposed.callbacks.XC_LoadPackage;</span><br><span class="line"></span><br><span class="line">import static de.robv.android.xposed.XposedHelpers.findClass;</span><br><span class="line"></span><br><span class="line">public class Xp_Demo implements IXposedHookLoadPackage &#123; //1.实现接口</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void handleLoadPackage(XC_LoadPackage.LoadPackageParam lpparam) throws Throwable &#123; //1.实现接口方法</span><br><span class="line">        //com.example.a91377.myapplication;</span><br><span class="line">        //com.tencent.mm</span><br><span class="line">        if (lpparam.packageName.equals(&quot;com.tencent.mm&quot;)) //进入其他应用的进程 -参数：包名</span><br><span class="line">        &#123;</span><br><span class="line">            try&#123;</span><br><span class="line">                XposedHelpers.findAndHookMethod(Application.class,</span><br><span class="line">                        &quot;attach&quot;,</span><br><span class="line">                        Context.class,</span><br><span class="line">                        new XC_MethodHook() &#123;</span><br><span class="line">                            @Override</span><br><span class="line">                            protected void afterHookedMethod(MethodHookParam param) throws Throwable &#123;</span><br><span class="line">                                super.afterHookedMethod(param);</span><br><span class="line">                                Context context = (Context)param.args[0];</span><br><span class="line">                                ClassLoader classLoader = context.getClassLoader();</span><br><span class="line">                                HookLocation(classLoader);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;);</span><br><span class="line">            &#125;catch (Throwable e)&#123;</span><br><span class="line">                XposedBridge.log(e);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void HookLocation(ClassLoader classLoader) throws ClassNotFoundException&#123;</span><br><span class="line">        Class&lt;?&gt; runnable = findClass(&quot;java.lang.Runnable&quot;, classLoader);</span><br><span class="line">        // hook android.os.Handler.post</span><br><span class="line">        XposedHelpers.findAndHookMethod(</span><br><span class="line">                &quot;android.os.Handler&quot;, classLoader, &quot;post&quot;, runnable,</span><br><span class="line">                new XC_MethodHook() &#123;</span><br><span class="line">                    @Override</span><br><span class="line">                    protected void afterHookedMethod(MethodHookParam param)</span><br><span class="line">                            throws Throwable &#123;</span><br><span class="line">                        boolean flag2 = false;</span><br><span class="line">                        long threadId = 00000;</span><br><span class="line">                        for (Map.Entry&lt;Thread, StackTraceElement[]&gt; stackTrace : Thread.getAllStackTraces().entrySet()) &#123;</span><br><span class="line">                            Thread thread = (Thread) stackTrace.getKey();</span><br><span class="line">                            StackTraceElement[] stack = (StackTraceElement[]) stackTrace.getValue();</span><br><span class="line"></span><br><span class="line">                            // 进行过滤</span><br><span class="line">                            if (!thread.equals(Thread.currentThread())) &#123;</span><br><span class="line">                                continue;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            for (StackTraceElement stackTraceElement : stack) &#123;</span><br><span class="line">                                if (stackTraceElement.getClassName().equals(&quot;com.tencent.mm.plugin.appbrand.jsapi.d&quot;) &amp;&amp; stackTraceElement.getMethodName().equals(&quot;a&quot;)) &#123;</span><br><span class="line">                                    flag2 = true;</span><br><span class="line">                                    break;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            if (!flag2) &#123;</span><br><span class="line">                                break;</span><br><span class="line">                            &#125;</span><br><span class="line">                            threadId = thread.getId();</span><br><span class="line">                            Log.i(&quot;hookgetPostMessage&quot;, String.valueOf(param.args[0]) + &quot;********&quot; + thread.getName() + &quot;-------&quot; + thread.getId());</span><br><span class="line"></span><br><span class="line">                        &#125;</span><br><span class="line">                        if (flag2) &#123;</span><br><span class="line">                            Message m = (Message) param.getResult();</span><br><span class="line">                            m.what = (int) threadId;</span><br><span class="line">                            param.setResult(m);</span><br><span class="line"></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">        // hook android.os.Handler.dispatchMessage</span><br><span class="line">        Class&lt;?&gt; message = findClass(&quot;android.os.Message&quot;, classLoader);</span><br><span class="line">        XposedHelpers.findAndHookMethod(</span><br><span class="line">                &quot;android.os.Handler&quot;, classLoader, &quot;dispatchMessage&quot;, message,</span><br><span class="line">                new XC_MethodHook() &#123;</span><br><span class="line">                    @Override</span><br><span class="line">                    protected void afterHookedMethod(MethodHookParam param)</span><br><span class="line">                            throws Throwable &#123;</span><br><span class="line">                        Message m = (Message) param.args[0];</span><br><span class="line">                        Runnable r = m.getCallback();</span><br><span class="line">                        int relatedThreadId = m.what;</span><br><span class="line">                        if(r == null)&#123;</span><br><span class="line">                            return;</span><br><span class="line">                        &#125;</span><br><span class="line">                        String tag = &quot;=========handleCallback&quot;;</span><br><span class="line">                        String msg = &quot;runnable:  &quot; + String.valueOf(r) + &quot;********&quot; + &quot;relatedThreadid: &quot; + String.valueOf(relatedThreadId) + &quot;---&quot; + &quot;currentId: &quot;;</span><br><span class="line">                        printLog(tag,msg);</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">        // hook invokeHandler 打印出线程ID和第一个参数, 即小程序的api</span><br><span class="line">        XposedHelpers.findAndHookMethod(</span><br><span class="line">                //7.0.20 d 类的 y 方法</span><br><span class="line">                &quot;com.tencent.mm.plugin.appbrand.jsapi.d&quot;, classLoader, &quot;y&quot;, String.class, String.class, int.class, // 被Hook函数的名称</span><br><span class="line">                new XC_MethodHook() &#123;</span><br><span class="line">                    @Override</span><br><span class="line">                    protected void afterHookedMethod(MethodHookParam param)</span><br><span class="line">                            throws Throwable &#123;</span><br><span class="line">                        String tag = &quot;[Dump Stack]&quot;;</span><br><span class="line">                        String msg = &quot;=====miniAppApi&quot; + String.valueOf(param.args[0]) + &quot;*******&quot;;</span><br><span class="line">                        printLog(tag,msg);</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //hook dangerous Android APi</span><br><span class="line">        String methodList[][] = com.example.a91377.xpdemo.Method.methodList;</span><br><span class="line">        for (int i = 0; i &lt; methodList.length; i++) &#123;</span><br><span class="line">            Class&lt;?&gt; clazz = findClass(methodList[i][0], classLoader);</span><br><span class="line">            for (Method method : clazz.getDeclaredMethods()) &#123;</span><br><span class="line">                final String methodName = method.getName();</span><br><span class="line">                if (!methodName.equals(methodList[i][1])) &#123;</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">                if (!Modifier.isAbstract(method.getModifiers())) &#123;</span><br><span class="line"></span><br><span class="line">                    XposedBridge.hookMethod(method, new XC_MethodHook() &#123;</span><br><span class="line">                        @Override</span><br><span class="line">                        protected void afterHookedMethod(MethodHookParam param) throws Throwable &#123;</span><br><span class="line">                            String tag = &quot;[hookWifi]&quot;;</span><br><span class="line">                            String msg = &quot;****&quot; + methodName + &quot;threadId&quot;;</span><br><span class="line">                            printLog(tag,msg);</span><br><span class="line"></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void printLog(String tag, String msg) &#123;</span><br><span class="line">        for (Map.Entry&lt;Thread, StackTraceElement[]&gt; stackTrace : Thread.getAllStackTraces().entrySet()) &#123;</span><br><span class="line">            Thread thread = (Thread) stackTrace.getKey();</span><br><span class="line">            StackTraceElement[] stack = (StackTraceElement[]) stackTrace.getValue();</span><br><span class="line">            // 进行过滤</span><br><span class="line">            if (!thread.equals(Thread.currentThread())) &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            String threadName = thread.getName();</span><br><span class="line">            long threadId = thread.getId();</span><br><span class="line">            Log.d(tag, msg + threadId);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // IXposedHookLoadPackage.java</span><br><span class="line">    // 1. handleLoadPackage, 这个方法用于在加载应用程序包的时候执行用户操作</span><br><span class="line">    // 2. final LoadPackageParam lpparam 这个参数包含了加载应用程序的基本信息</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    // XposedHelpers.java</span><br><span class="line">    //findAndHookMethod 是一个辅助方法，可以静态导入使用</span><br><span class="line">    //参数： 1. 需要hook住的类名 2. 需要hook住的方法名 3.回调函数，参数集包含了（1. hook的目标方法的参数， 2 回调方法）</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //XposedBridge.java</span><br><span class="line">    // 1. 无参方法：log 该方法可以将log信息以及Throwable 抛出的异常信息输出到标准的logcat以及/data/Xposed/debug.log这个文件中</span><br><span class="line">    // 2. 无参方法 hookAllMethods/hookAllConstructors 该方法可以用来hook住某个类中所有方法或者构造函数</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/04/15/apinath/" data-id="cl1zs4wvr0000lgwx3s1u5xip" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%B0%8F%E7%A8%8B%E5%BA%8F/" rel="tag">小程序</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-miniscrawler" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/03/31/miniscrawler/" class="article-date">
  <time datetime="2022-03-31T12:03:23.000Z" itemprop="datePublished">2022-03-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/03/31/miniscrawler/">【技术】【小程序】MiniScrawler 工具原理解析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>之前用到了文章<a target="_blank" rel="noopener" href="https://web.cse.ohio-state.edu/~lin.3021/file/SIGMETRICS21.pdf">A Measurement Study of Wechat Mini-Apps</a>提出的微信小程序半自动化收集工具<a target="_blank" rel="noopener" href="https://github.com/OSUSecLab/MiniCrawler">MiniCrawler</a>。最近深入看一下工具实现细节。</p>
<h1 id="工具介绍"><a href="#工具介绍" class="headerlink" title="工具介绍"></a>工具介绍</h1><p>工具有两个功能，一是小程序元数据收集，另一个是小程序包下载。</p>
<h2 id="小程序元数据收集"><a href="#小程序元数据收集" class="headerlink" title="小程序元数据收集"></a>小程序元数据收集</h2><p>具体原理不难，就是拿到用户的请求参数，然后替换 request 中的 keyword 字段，批量发起请求。</p>
<ul>
<li>用户手动在小程序搜索页面输入关键词，工具会帮助拿到用户向服务七搜索请求的一些参数，主要是认证参数</li>
<li>用户把这些参数和待搜索词列表放在指定位置</li>
<li>工具即可用这些拿到的参数批量发起小程序搜索请求，拿到服务器返回的多个小程序的元数据（小程序名、小程序 AppId 等）</li>
</ul>
<h2 id="小程序包下载"><a href="#小程序包下载" class="headerlink" title="小程序包下载"></a>小程序包下载</h2><p><strong>要求</strong></p>
<ol>
<li>微信 App 得是 7.0.20 版本</li>
<li>编译并安装 XposedPlugin</li>
<li>打开任意小程序页面</li>
<li>运行 <code>adb shell am broadcast -a android.intent.myper --es appid &quot;&#123;待下载小程序的appid&#125;&quot;</code>，工具会自动下载链接及相关信息到 /sdcard/apps.txt</li>
</ol>
<h3 id="逆向-XposedPlugin"><a href="#逆向-XposedPlugin" class="headerlink" title="逆向 XposedPlugin"></a>逆向 XposedPlugin</h3><p>看了 XposedPlugin 源码，注册了个 <code>android.intent.myper</code> 的 receiver 用来接收待下载小程序的 appid。</p>
<p>Q：具体如何起到启动目标小程序的作用？<br>A：<code>com.example.vsa.xposedutility.tests.WechatMiniAppsDownloader</code> 中，工具接了 appid 之后 invoke 了小程序 API（代码如下）。通过调起 <code>wx.navigateToMiniProgram</code>，appid 作为参数传进去，达到从当前小程序（任意的，但需要是小程序的 context）跳转到目标小程序的目的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Method method = next.getClass().getMethod(&quot;invokeHandler&quot;, String.class, String.class, Integer.TYPE);</span><br><span class="line">method.invoke(next, &quot;navigateToMiniProgram&quot;, &quot;&#123;\&quot;appId\&quot;:\&quot;&quot; + stringExtra + &quot;\&quot;,\&quot;extraData\&quot;:\&quot;\&quot;,\&quot;envVersion\&quot;:\&quot;release\&quot;,\&quot;scene\&quot;:1037,\&quot;sceneNote\&quot;:\&quot;\&quot;&#125;&quot;, 9999);</span><br></pre></td></tr></table></figure>

<p>Q：如何拿到下载链接及包的相关信息？<br>A：<code>com.example.vsa.xposedutility.tests.Wechat7020</code> 类中 <code>hookAll</code> 中可以看出（如下图），关注的是微信 App 里的两个类：<code>com.tencent.mm.plugin.appbrand.appcache.ba</code>、<code>com.tencent.mm.plugin.appbrand.jsapi.l</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public void beforeHookedMethod(XC_MethodHook.MethodHookParam methodHookParam) throws Throwable &#123;</span><br><span class="line">    Log.d(Wechat7020.TAG, &quot;----&gt;&gt;&gt;:&quot; + methodHookParam.method.getName());</span><br><span class="line">    Utilities.printParameter(Wechat7020.TAG, methodHookParam);</span><br><span class="line">    if (methodHookParam.method.getName().equals(&quot;invokeHandler&quot;) &amp;&amp; !Wechat7020.did) &#123;</span><br><span class="line">        Wechat7020.did = true;</span><br><span class="line">        methodHookParam.thisObject.getClass().getMethod(&quot;invokeHandler&quot;, String.class, String.class, Integer.TYPE);</span><br><span class="line">    &#125;</span><br><span class="line">    if (methodHookParam.method.getDeclaringClass().getName().equals(&quot;com.tencent.mm.plugin.appbrand.appcache.ba&quot;) &amp;&amp; (methodHookParam.method instanceof Constructor) &amp;&amp; ((Constructor) methodHookParam.method).getParameterTypes().length == 4) &#123;</span><br><span class="line">        Utilities.writeToFile(&quot;/sdcard/apps.txt&quot;, (methodHookParam.args[0] + BuildConfig.FLAVOR) + &quot; &quot; + (methodHookParam.args[2] + BuildConfig.FLAVOR) + &quot; &quot; + (methodHookParam.args[3] + BuildConfig.FLAVOR) + &quot;\n&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    if (methodHookParam.method.getDeclaringClass().getName().equals(&quot;com.tencent.mm.plugin.appbrand.jsapi.l&quot;) &amp;&amp; !WechatMiniAppsDownloader.wvs.contains(methodHookParam.thisObject)) &#123;</span><br><span class="line">        WechatMiniAppsDownloader.wvs.add(methodHookParam.thisObject);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="逆向微信"><a href="#逆向微信" class="headerlink" title="逆向微信"></a>逆向微信</h3><p><strong>com.tencent.mm.plugin.appbrand.appcache.ba</strong><br>根据 XposedPlugin 代码行为，应该在 hook 到该类之后写数据（包下载 url）到 <code>/sdcard/apps.txt</code>，但实测后没有该文件。只有在初始，需要下载微信小程序 jssdk 包的时候会调用一下，但下载普通小程序根本不走这。<br>自己又静态分析了一阵，找到了 <code>com.tencent.mm.plugin.appbrand.appcache.bt.a(str,...)</code> 方法，参数 str 就是下载链接。不知道为什么在我这边是 <code>.bt</code> 类，而作者那边是 <code>.ba</code> 类，apk 版本是一样的。</p>
<p><strong>com.tencent.mm.plugin.appbrand.jsapi.l</strong><br>里面 <code>invokeHandler</code> 是调起小程序 api 的方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public final String invokeHandler(String str, String str2, int i)</span><br></pre></td></tr></table></figure>

<p>里面 str 就是 invoke 的小程序方法名，本场景下是 <code>navigateToMiniProgram</code>，str2 是传给这个小程序方法的参数，本场景下是 JSON，包括 appId 等信息。<br>函数体内有一句<code>String y = dVar.y(str, str2, i);</code>，这里 trace 到后面是一个抽象类，该抽象类由多个子类实现。这些子类与 <code>wx.&#123;subAPI&#125;</code> 一一对应。<code>navigateToMiniprogram</code> 是 <code>com.tencent.mm.plugin.appbrand.jsapi.miniprogram_navigator.g</code>。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/03/31/miniscrawler/" data-id="cl1ezf4650000fcwx5y0h8eyw" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%B0%8F%E7%A8%8B%E5%BA%8F/" rel="tag">小程序</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-esprimae" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/03/24/esprimae/" class="article-date">
  <time datetime="2022-03-24T13:07:25.000Z" itemprop="datePublished">2022-03-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/03/24/esprimae/">【技术】【JS 静态分析】Javascript 分析工具 Esprima</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>之前分析 JS 用到的工具，用于生成 JS 的 AST，马克一下工具用法。</p>
<h1 id="Esprima"><a href="#Esprima" class="headerlink" title="Esprima"></a>Esprima</h1><p>官网：<a target="_blank" rel="noopener" href="https://docs.esprima.org/en/stable/getting-started.html">https://docs.esprima.org/en/stable/getting-started.html</a><br>体验网址：<a target="_blank" rel="noopener" href="https://esprima.org/demo/parse.html#">https://esprima.org/demo/parse.html#</a><br>参考资料：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/47d9b2a365c5">https://www.jianshu.com/p/47d9b2a365c5</a></p>
<h2 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h2><p>是一个用于对 JS 代码做词法或者语法分析的工具，只支持js，不支持 flow 或者 typescript 格式。语法格式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">esprima.parseScript(input, config, delegate)</span><br><span class="line">esprima.parseModule(input, config, delegate)</span><br></pre></td></tr></table></figure>

<p>input 代表原始 js 字符串；config 是如下的配置对象：<br><img src="/pics/esprima/image.png" alt="配置对象"></p>
<h2 id="语法树解析"><a href="#语法树解析" class="headerlink" title="语法树解析"></a>语法树解析</h2><ul>
<li>语法树的总体结构就两种<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">interface Program &#123;</span><br><span class="line">  type: &#x27;Program&#x27;;</span><br><span class="line">  sourceType: &#x27;script&#x27;;</span><br><span class="line">  body: StatementListItem[];</span><br><span class="line">&#125;</span><br><span class="line">interface Program &#123;</span><br><span class="line">  type: &#x27;Program&#x27;;</span><br><span class="line">  sourceType: &#x27;module&#x27;;</span><br><span class="line">  body: ModuleItem[];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 变量声明及执行语句</span><br><span class="line">type StatementListItem = Declaration | Statement;</span><br><span class="line">// 变量声明、执行语句、导入导出模块</span><br><span class="line">type ModuleItem = ImportDeclaration | ExportDeclaration | StatementListItem;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>_<strong>Declaration</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">type Declaration = ClassDeclaration | FunctionDeclaration |  VariableDeclaration;</span><br></pre></td></tr></table></figure>

<p>_<strong>Statement</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">type Statement = BlockStatement | BreakStatement | ContinueStatement |</span><br><span class="line">    DebuggerStatement | DoWhileStatement | EmptyStatement |</span><br><span class="line">    ExpressionStatement | ForStatement | ForInStatement |</span><br><span class="line">    ForOfStatement | FunctionDeclaration | IfStatement |</span><br><span class="line">    LabeledStatement | ReturnStatement | SwitchStatement |</span><br><span class="line">    ThrowStatement | TryStatement | VariableDeclaration |</span><br><span class="line">    WhileStatement | WithStatement;</span><br></pre></td></tr></table></figure>

<p>_<strong>其中 ExpressionStatement</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">interface ExpressionStatement &#123;</span><br><span class="line">    type: &#x27;ExpressionStatement&#x27;;</span><br><span class="line">    expression: Expression;</span><br><span class="line">    directive?: string;</span><br><span class="line">&#125;</span><br><span class="line">// Expression 类型</span><br><span class="line">type Expression = ThisExpression | Identifier | Literal |</span><br><span class="line">    ArrayExpression | ObjectExpression | FunctionExpression | ArrowFunctionExpression | ClassExpression |</span><br><span class="line">    TaggedTemplateExpression | MemberExpression | Super | MetaProperty |</span><br><span class="line">    NewExpression | CallExpression | UpdateExpression | AwaitExpression | UnaryExpression |</span><br><span class="line">    BinaryExpression | LogicalExpression | ConditionalExpression |</span><br><span class="line">    YieldExpression | AssignmentExpression | SequenceExpression;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/03/24/esprimae/" data-id="cl150p0p800008gwxap6v9pmu" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/javascript/" rel="tag">javascript</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Xposed" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/03/17/Xposed/" class="article-date">
  <time datetime="2022-03-17T07:50:27.000Z" itemprop="datePublished">2022-03-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/03/17/Xposed/">【BUG 体质康复日记】尝试在 Android 10 安装 Xposed 踩的坑</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="由于需要在新测试机（Android-10）上使用-Xposed，记录一下踩坑心得（苦涩-jpg"><a href="#由于需要在新测试机（Android-10）上使用-Xposed，记录一下踩坑心得（苦涩-jpg" class="headerlink" title="由于需要在新测试机（Android 10）上使用 Xposed，记录一下踩坑心得（苦涩.jpg)"></a>由于需要在新测试机（Android 10）上使用 Xposed，记录一下踩坑心得（苦涩.jpg)</h1><h1 id="踩到的坑"><a href="#踩到的坑" class="headerlink" title="踩到的坑"></a>踩到的坑</h1><h2 id="Xposed-报错“下载-http-dl-xposed-info-repo-full-xml-gz-失败”"><a href="#Xposed-报错“下载-http-dl-xposed-info-repo-full-xml-gz-失败”" class="headerlink" title="Xposed 报错“下载 http://dl.xposed.info/repo/full.xml.gz 失败”"></a>Xposed 报错“下载 <a target="_blank" rel="noopener" href="http://dl.xposed.info/repo/full.xml.gz">http://dl.xposed.info/repo/full.xml.gz</a> 失败”</h2><p>错误原因：用了 http 协议，应该是 https 协议<br>解决方法：改 apk 包，对应字段的 http 改成 https 就好（苦涩.jpg)</p>
<h2 id="框架无响应"><a href="#框架无响应" class="headerlink" title="框架无响应"></a>框架无响应</h2><p>无报错，并且安装成功后，Xposed 无法正常使用，表现为操作无响应<br>原因应该是 Xposed 框架很久不更新了，无法兼容较新的系统版本。</p>
<h2 id="Android-10-上-Xposed-的正确打开方式"><a href="#Android-10-上-Xposed-的正确打开方式" class="headerlink" title="Android 10 上 Xposed 的正确打开方式"></a>Android 10 上 Xposed 的正确打开方式</h2><p>最终为了快速解决问题上手干活用了 <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/348857520">LSposed</a></p>
<h1 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h1><h2 id="Android-Zygote进程"><a href="#Android-Zygote进程" class="headerlink" title="Android Zygote进程"></a>Android Zygote进程</h2><p>Zygote 进程是 Android 系统第一个拥有 Java 运行环境的进程，由用户空间第一个进程 init 进程通过 init.rc 文件创建，从 init 进程（pid 为 1） fork 而来。所有 APP 进程都是由 Zygote fork 出来，Zygote 进程在启动过程将创建 Java ART 虚拟机，预加载一个 Java 进程需要的所有资源，子进程被创建后就可以直接使用这些资源。</p>
<h2 id="Xposed-原理"><a href="#Xposed-原理" class="headerlink" title="Xposed 原理"></a>Xposed 原理</h2><p>Xposed 会替换 Zygote 进程达到控制所有 APP 进程的目的。<br>Xposed 通过修改 ART/Dalvik 虚拟机，注册需要 hook 的函数为 Native 函数，这样执行到相应函数时，虚拟机优先执行 Narive 函数，然后执行 Java 函数。</p>
<h3 id="基于-Dalvik-的-Hook"><a href="#基于-Dalvik-的-Hook" class="headerlink" title="基于 Dalvik 的 Hook"></a>基于 Dalvik 的 Hook</h3><p>将被 Hook 方法修改为一个 JNI 方法，然后绑定一个 Xposed 自定义处理方法逻辑的函数上。</p>
<p>被 Hook 方法调用过程</p>
<ul>
<li>Dalvik 将会进行代码的解释执行，Java 方法进入 Dalvik 虚拟机中会被转化为一个 Method 对象</li>
<li>虚拟机判断这个方法如果是一个 JNI 方法，就会直接调用它绑定的的 nativeFunc 函数</li>
<li>来到 Xposed 处理 Hook 的函数中，这个函数将这个被 Hook 方法的参数进行转发，让 Xposed 模块提供的处理 Hook 的回调方法来接管原来的逻辑，获得新的返回值返回给被 Hook 方法，即可完成整个 Hook 操作</li>
</ul>
<h3 id="基于-ART-的-Hook"><a href="#基于-ART-的-Hook" class="headerlink" title="基于 ART 的 Hook"></a>基于 ART 的 Hook</h3><p>需要重新修改编译 ART 虚拟机的源码，重新编译出 ART 虚拟机的可执行文件 libart.so，替换 Android 系统中的 ART 虚拟机。核心原理就是直接修改一个方法对应的汇编代码的地址，让方法直接跳转到指定地址执行，然后就可以执行自定义的逻辑进行 Hook 处理。</p>
<p>被 Hook 方法调用过程</p>
<ul>
<li>ART 对方法代码进行执行，首先这个 Java 方法在 ART 虚拟机中将使用一个 ArtMethod 对象表示</li>
<li>进入 ART 的 Java 方法执行函数中，会跳入一段蹦床代码中进行执行，这段蹦床代码又会跳入这个 ArtMethod 对象设置的汇编代码地址处</li>
<li>进而执行到 Xposed 用于处理 Hook 的代码中，之后完成 Hook 逻辑</li>
</ul>
<p>参考资料<br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/6b4a80654d4e">https://www.jianshu.com/p/6b4a80654d4e</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_47883636/article/details/109018440">https://blog.csdn.net/weixin_47883636/article/details/109018440</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/03/17/Xposed/" data-id="cl0uz4nbu00001gwx3rsf6k8p" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/BUG%E5%8F%8D%E6%80%9D/" rel="tag">BUG反思</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-paperCCS20" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/03/11/paperCCS20/" class="article-date">
  <time datetime="2022-03-11T06:06:32.000Z" itemprop="datePublished">2022-03-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/03/11/paperCCS20/">【paper summary】Demystifying Resource Management Risks in Emerging Mobile App-in-App Ecosystems</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="梳理小程序相关工作中碰到的比较有价值的一篇文章，整理并总结一下。"><a href="#梳理小程序相关工作中碰到的比较有价值的一篇文章，整理并总结一下。" class="headerlink" title="梳理小程序相关工作中碰到的比较有价值的一篇文章，整理并总结一下。"></a>梳理小程序相关工作中碰到的比较有价值的一篇文章，整理并总结一下。</h1><h1 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h1><h2 id="文章信息"><a href="#文章信息" class="headerlink" title="文章信息"></a>文章信息</h2><ul>
<li>Demystifying Resource Management Risks in Emerging Mobile App-in-App Ecosystems</li>
<li>link：<a target="_blank" rel="noopener" href="https://dl.acm.org/doi/pdf/10.1145/3372297.3417255">https://dl.acm.org/doi/pdf/10.1145/3372297.3417255</a></li>
<li>publish：CCS 20</li>
</ul>
<h2 id="文章内容"><a href="#文章内容" class="headerlink" title="文章内容"></a>文章内容</h2><ol>
<li><p>研究什么？<br>作者分析小程序框架安全，提出三类小程序生态系统中，由于资源管理不完善引起的<strong>三类漏洞</strong>。对三类漏洞进行<strong>阐述、攻击验证、提出检测方法及缓解措施</strong>。</p>
</li>
<li><p>作者贡献？</p>
</li>
</ol>
<ul>
<li>提出现有 app-in-app 生态系统中资源管理方式存在的安全性问题。提出三种攻击方式，并简单验证。<strong>个人认为三种攻击影响确实蛮大的</strong>，后面具体介绍。</li>
<li>对自己发现的问题进行一个 measurement study，其中借助了自己开发的自动化检测工具，叫 apinat。个人认为这个工具贡献技术上贡献不太强，主要为检测两类漏洞辅助。（<strong>为什么是检测两类漏洞，不是检测三类漏洞，因为第三个漏洞确实不需要特别检测，后续具体介绍。</strong>）</li>
<li>总结一些经验教训与问题相应的缓解措施.</li>
</ul>
<h1 id="三类漏洞"><a href="#三类漏洞" class="headerlink" title="三类漏洞"></a>三类漏洞</h1><h2 id="敏感信息泄露"><a href="#敏感信息泄露" class="headerlink" title="敏感信息泄露"></a>敏感信息泄露</h2><h3 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h3><p><strong>本质就是不一致问题。</strong><br>小程序宿主 APP 对小程序 API 有权限管理，系统对系统 API 有权限管理，同时小程序 API 本质还是在 APP Native 层开发，必然涉及到一些系统 API。<br>因此小程序 API 实际由一批系统 API 实现，因此可以通过这些系统 API 映射到系统权限，即可以通过映射获取<strong>小程序 API 对应哪些系统权限</strong>，同时平台又对小程序开发者要求<strong>小程序 API 应当与何权限映射</strong>，此时存在两种映射关系，这两种映射的<strong>不一致</strong>将导致敏感资源泄露的问题。<br>如果一个小程序 API 没有被小程序平台严格约束，但底层实现的代码调用了涉及敏感资源的 API，则该小程序 API 将造成敏感资源泄露。作者将之命名为 Encapsulated API。</p>
<h3 id="检测方法"><a href="#检测方法" class="headerlink" title="检测方法"></a>检测方法</h3><ol>
<li>关注没有被小程序平台列为涉及敏感资源的小程序 API</li>
<li>构造（小程序 API - 系统 APIs - 系统权限）这样一种映射</li>
<li>若某 API 映射的系统权限敏感，则检测到</li>
</ol>
<p>Q：作者如何构造这样一种映射？<br>A：</p>
<ol>
<li>使用 funfuzz 工具 invoke 几乎每一个小程序 API，如 invoke 失败则手动构造 input。由此得到<strong>小程序 API - 系统 APIs 的映射</strong></li>
<li>由于作者认为，现有的系统 API 到系统权限的映射不够精确，因此作者选择人工构造 <strong>系统 API - 系统权限的映射</strong>。</li>
<li>由此得到完整的（小程序 API - 系统 APIs - 系统权限）映射</li>
</ol>
<h2 id="窗口欺骗"><a href="#窗口欺骗" class="headerlink" title="窗口欺骗"></a>窗口欺骗</h2><h3 id="描述-1"><a href="#描述-1" class="headerlink" title="描述"></a>描述</h3><p><strong>类似钓鱼</strong>。针对 web app 这类平台（safari、chrome 等），存在伪造登录页面的机会；针对微信、支付宝这类平台，伪造小程序付款页面。</p>
<h3 id="检测方法-1"><a href="#检测方法-1" class="headerlink" title="检测方法"></a>检测方法</h3><ol>
<li>仍然借助 funfuzz 将每个小程序 API invoke 一遍</li>
<li>对比调用 API 前后的截图内容，识别是否存在<strong>敏感字段</strong>，从而判断是否存在窗口欺骗的潜在风险。</li>
</ol>
<p>Q：敏感字段哪里来？如何定义？<br>A：参考前人工作 <a target="_blank" rel="noopener" href="https://cs.uwaterloo.ca/~yaafer/teaching/papers/nan2018ndss.pdf">NDSS18</a> 提供的敏感字段列表</p>
<h2 id="小程序伪装"><a href="#小程序伪装" class="headerlink" title="小程序伪装"></a>小程序伪装</h2><h3 id="描述-2"><a href="#描述-2" class="headerlink" title="描述"></a>描述</h3><p>仅针对安卓系统，因为 iOS 系统对小程序的页面管理略不同。具体来说，iOS 系统不会在“最近使用”页面显示单个小程序，而安卓系统会将小程序与 APP 并列显示，这就为攻击者提供伪造小程序的机会。<br>作者观察到一个事实，每个小程序平台 APP 都有一个<strong>magic number</strong>，用于管理显示小程序数量。一旦打开的小程序数量超过这个数字，APP 将在后台静默关闭第一个打开的小程序。由于用户并不知道这样一个事实，因此在 APP 静默关闭第一个小程序后，攻击者可以通过伪造 UI 装作是第一个小程序仍然打开，欺骗用户进行敏感操作。</p>
<h3 id="检测方法-2"><a href="#检测方法-2" class="headerlink" title="检测方法"></a>检测方法</h3><p>由于 magic number 及每个 APP 会静默关闭第一个小程序这个事实确然存在，因此无需检测，这些平台 APP 都存在被攻击者使用 UI 欺骗窃取用户敏感信息的风险。</p>
<h1 id="评价"><a href="#评价" class="headerlink" title="评价"></a>评价</h1><p>这篇文章第一个研究小程序框架安全，研究对象涵盖海内外各大 Super APP。作者验证了三类漏洞确实存在，且对小程序用户影响深远，研究意义重大。<br>在技术方面，作者没有突出的贡献，但是设计的 Apinat 能够检测上述漏洞，且作者开源了一些对后续工作有帮助的资源或代码参考，还是为小程序安全研究做了很大贡献的。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/03/11/paperCCS20/" data-id="cl0m0x4vi0000g8wx6asj1e7h" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/paperSummary/" rel="tag">paperSummary</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android/" rel="tag">Android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android%E9%9A%90%E7%A7%81/" rel="tag">Android隐私</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/BUG%E5%8F%8D%E6%80%9D/" rel="tag">BUG反思</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/" rel="tag">hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/javascript/" rel="tag">javascript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/paperSummary/" rel="tag">paperSummary</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B0%8F%E7%A8%8B%E5%BA%8F/" rel="tag">小程序</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Android/" style="font-size: 16.67px;">Android</a> <a href="/tags/Android%E9%9A%90%E7%A7%81/" style="font-size: 10px;">Android隐私</a> <a href="/tags/BUG%E5%8F%8D%E6%80%9D/" style="font-size: 10px;">BUG反思</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/javascript/" style="font-size: 10px;">javascript</a> <a href="/tags/paperSummary/" style="font-size: 13.33px;">paperSummary</a> <a href="/tags/%E5%B0%8F%E7%A8%8B%E5%BA%8F/" style="font-size: 20px;">小程序</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">May 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">April 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">March 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">February 2022</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/05/29/ui2/">【知识】【python】【adb】uiautomator2 包文档</a>
          </li>
        
          <li>
            <a href="/2022/05/21/JsBridge/">【知识】【安卓】JsBridge</a>
          </li>
        
          <li>
            <a href="/2022/05/13/policyLint/">【技术】【安卓隐私合规】policyLint 工具原理解析</a>
          </li>
        
          <li>
            <a href="/2022/05/13/pythoncmdadb/">【技术】【adb】python 脚本在 cmd 控制 adb</a>
          </li>
        
          <li>
            <a href="/2022/04/22/unpackwxError/">【技术】【小程序】wxUnpacker 工具“SyntaxError： Illegal return statement” 错误</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>